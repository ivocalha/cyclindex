<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">
  <title>Rider Score â€“ Cyclindex</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">
  <style>
    @font-face { font-family: 'Suissnord'; src: url('Suissnord.otf') format('opentype'); font-display: swap; }
    body { background:#0f172a; color:white; margin:0; padding:0; }

    /* Table container */
    .table-wrapper { position: relative; max-height: 80vh; overflow: auto; }
    #riderTable { background:rgba(255,255,255,0.08); backdrop-filter:blur(24px); border-radius:2rem; overflow:hidden; box-shadow:0 40px 120px rgba(0,0,0,0.95); }
    #riderTable thead th { 
      background:#1e40af !important; 
      font-family:'Suissnord',sans-serif; 
      font-size:1.15rem !important; 
      padding:1rem 0.5rem !important; 
      text-align:center; 
      font-weight:bold; 
      position: sticky; 
      top: 0; 
      z-index: 10; 
    }
    #riderTable tbody td { 
      padding:0.7rem 0.4rem !important; 
      text-align:center; 
      vertical-align:middle; 
      font-size:0.89rem; 
      line-height:1.2; 
    }
    #riderTable tbody tr:hover { background:rgba(59,130,246,0.28) !important; }

    .flag-img { width:23px; height:17px; border-radius:2px; box-shadow:0 1px 3px rgba(0,0,0,0.6); transition:transform .2s; }
    .flag-img:hover { transform:scale(2.2); }
    .tooltip { 
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%); 
      background:rgba(0,0,0,0.94); color:white; padding:6px 10px; border-radius:6px; 
      font-size:0.84rem; white-space:nowrap; pointer-events:none; opacity:0; 
      transition:opacity .2s; margin-bottom:6px; z-index:1000; 
    }
    .flag-container:hover .tooltip { opacity:1; }
    .flag-container { position:relative; display:inline-block; cursor:help; }

    /* Navigation Bar */
    .nav-bar { 
      background: rgba(15,23,42,0.9); 
      backdrop-filter: blur(12px); 
      padding: 1rem 2rem; 
      position: sticky; 
      top: 0; 
      z-index: 1000; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.5); 
    }
    .nav-links { 
      display: flex; 
      justify-content: center; 
      gap: 2rem; 
      flex-wrap: wrap; 
    }
    .nav-links a { 
      color: white; 
      font-family: 'Suissnord', sans-serif; 
      font-size: 1.1rem; 
      text-decoration: none; 
      padding: 0.5rem 1rem; 
      border-radius: 0.8rem; 
      transition: all 0.3s; 
    }
    .nav-links a:hover { 
      background: rgba(59,130,246,0.4); 
      transform: translateY(-2px); 
    }
    .nav-links a.active {
      background: rgba(59,130,246,0.4);
    }
  </style>
</head>
<body>

  <!-- Navigation: Results Log between Home and Rider Score -->
  <nav class="nav-bar">
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="results-log.html">Results Log</a>
      <a href="rider-score.html" class="active">Rider Score</a>
      <a href="team-score.html">Team Score</a>
      <a href="nation-score.html">Nation Score</a>
      <a href="how-it-works.html">How It Works</a>
    </div>
  </nav>

  <!-- Table directly under navigation -->
  <div class="container mx-auto px-4 pt-4 pb-12">
    <div class="table-wrapper">
      <table id="riderTable" class="display nowrap" style="width:100%">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Nation</th>
            <th>Rider</th>
            <th>Score</th>
            <th>Date 1</th>
            <th>Team 1</th>
            <th>Race 1</th>
            <th>Rk1</th>
            <th>Type 1</th>
            <th>Sc1</th>
            <th>Date 2</th>
            <th>Team 2</th>
            <th>Race 2</th>
            <th>Rk2</th>
            <th>Type 2</th>
            <th>Sc2</th>
            <th>Date 3</th>
            <th>Team 3</th>
            <th>Race 3</th>
            <th>Rk3</th>
            <th>Type 3</th>
            <th>Sc3</th>
            <th>TRk</th>
            <th>NRk</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/rider-score.csv";

    const countryFlags = {
      "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao","Antigua and Barbuda":"ag","Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at",
      "Azerbaijan":"az","Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb","Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bhutan":"bt",
      "Bolivia":"bo","Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn","Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cabo Verde":"cv","Cambodia":"kh",
      "Cameroon":"cm","Canada":"ca","Central African Republic":"cf","Chad":"td","Chile":"cl","China":"cn","Colombia":"co","Comoros":"km","Congo":"cg","Costa Rica":"cr",
      "Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czechia":"cz","Denmark":"dk","Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Ecuador":"ec","Egypt":"eg",
      "El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er","Estonia":"ee","Eswatini":"sz","Ethiopia":"et","Fiji":"fj","Finland":"fi","France":"fr","Gabon":"ga",
      "Gambia":"gm","Georgia":"ge","Germany":"de","Ghana":"gh","Greece":"gr","Grenada":"gd","Guatemala":"gt","Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy",
      "Haiti":"ht","Honduras":"hn","Hungary":"hu","Iceland":"is","India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq","Ireland":"ie","Israel":"il",
      "Italy":"it","Ivory Coast":"ci","Jamaica":"jm","Japan":"jp","Jordan":"jo","Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki","Kosovo":"xk","Kuwait":"kw",
      "Kyrgyzstan":"kg","Laos":"la","Latvia":"lv","Lebanon":"lb","Lesotho":"ls","Liberia":"lr","Libya":"ly","Liechtenstein":"li","Lithuania":"lt","Luxembourg":"lu",
      "Madagascar":"mg","Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml","Malta":"mt","Marshall Islands":"mh","Mauritania":"mr","Mauritius":"mu","Mexico":"mx",
      "Micronesia":"fm","Moldova":"md","Monaco":"mc","Mongolia":"mn","Montenegro":"me","Morocco":"ma","Mozambique":"mz","Myanmar":"mm","Namibia":"na","Nauru":"nr",
      "Nepal":"np","Netherlands":"nl","New Zealand":"nz","Nicaragua":"ni","Niger":"ne","Nigeria":"ng","North Macedonia":"mk","Norway":"no","Oman":"om","Pakistan":"pk",
      "Palau":"pw","Palestine":"ps","Panama":"pa","Papua New Guinea":"pg","Paraguay":"py","Peru":"pe","Philippines":"ph","Poland":"pl","Portugal":"pt","Qatar":"qa",
      "Romania":"ro","Russia":"ru","Rwanda":"rw","Saint Kitts and Nevis":"kn","Saint Lucia":"lc","Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm",
      "Sao Tome and Principe":"st","Saudi Arabia":"sa","Senegal":"sn","Serbia":"rs","Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg","Slovakia":"sk","Slovenia":"si",
      "Solomon Islands":"sb","Somalia":"so","South Africa":"za","South Georgia and the South Sandwich Islands":"gs","South Korea":"kr","South Sudan":"ss",
      "Spain":"es","Sri Lanka":"lk","Sudan":"sd","Suriname":"sr","Svalbard and Jan Mayen":"sj","Sweden":"se","Switzerland":"ch","Syria":"sy","Taiwan":"tw","Tajikistan":"tj",
      "Tanzania":"tz","Thailand":"th","Timor-Leste":"tl","Togo":"tg","Tokelau":"tk","Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn","Turkey":"tr","Turkmenistan":"tm",
      "Turks and Caicos Islands":"tc","Tuvalu":"tv","Uganda":"ug","Ukraine":"ua","United Arab Emirates":"ae","United Kingdom":"gb","Great Britain":"gb","United States":"us",
      "United States Minor Outlying Islands":"um","Uruguay":"uy","Uzbekistan":"uz","Vanuatu":"vu","Vatican City":"va","Venezuela":"ve","Vietnam":"vn","Virgin Islands (British)":"vg",
      "Virgin Islands (U.S.)":"vi","Wallis and Futuna":"wf","Western Sahara":"eh","Yemen":"ye","Zambia":"zm","Zimbabwe":"zw"
    };

    fetch(CSV_URL)
      .then(r => r.text())
      .then(text => {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: true,
          delimiter: ";",
          trimHeaders: true,
          transformHeader: h => h.trim(),
          transform: v => v ? v.toString().trim() : ""
        });

        const tableData = parsed.data
          .filter(row => {
            const scoreStr = (row.Score || '').toString().trim().replace(',', '.');
            const score = parseFloat(scoreStr);
            return row.Rank && row.Rider && !isNaN(score) && score >= 41;
          })
          .map(row => {
            const country = row.Country || "";
            const code = countryFlags[country] || "";
            const flagHtml = code 
              ? `<div class="flag-container"><img src="https://flagcdn.com/48x36/${code}.png" class="flag-img" alt="${country}" loading="lazy"><div class="tooltip">${country}</div></div>`
              : country;

            // Format Score: exactly 2 decimal places, rounded properly
            const scoreNum = parseFloat((row.Score || '').toString().replace(',', '.'));
            const formattedScore = isNaN(scoreNum) ? '' : scoreNum.toLocaleString('pt-PT', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            });

            return [
              row.Rank ?? "",
              flagHtml,
              row.Rider ?? "",
              formattedScore,
              row.Date1 ?? "",
              row.Team1 ?? "",
              row.Event1 ?? "",
              row.Rank1 ?? "",
              row.Results_Type1 ?? "",
              row.Level1 ?? "",
              row.Date2 ?? "",
              row.Team2 ?? "",
              row.Event2 ?? "",
              row.Rank2 ?? "",
              row.Results_Type2 ?? "",
              row.Level2 ?? "",
              row.Date3 ?? "",
              row.Team3 ?? "",
              row.Event3 ?? "",
              row.Rank3 ?? "",
              row.Results_Type3 ?? "",
              row.Level3 ?? "",
              row.rider_team_rank ?? "",
              row.rider_country_rank ?? ""
            ];
          });

        $('#riderTable').DataTable({
          data: tableData,
          columns: [
            { title: "Rank" },
            { title: "Nation" },
            { title: "Rider" },
            { title: "Score" },
            { title: "Date 1" },
            { title: "Team 1" },
            { title: "Race 1" },
            { title: "Rk1" },
            { title: "Type 1" },
            { title: "Sc1" },
            { title: "Date 2" },
            { title: "Team 2" },
            { title: "Race 2" },
            { title: "Rk2" },
            { title: "Type 2" },
            { title: "Sc2" },
            { title: "Date 3" },
            { title: "Team 3" },
            { title: "Race 3" },
            { title: "Rk3" },
            { title: "Type 3" },
            { title: "Sc3" },
            { title: "TRk" },
            { title: "NRk" }
          ],
          pageLength: 100,
          lengthMenu: [50, 100, 250],
          order: [[0, 'asc']],
          scrollX: true,
          scrollY: '60vh',
          scrollCollapse: true,
          colReorder: true,
          dom: 'frtip',
          language: { 
            search: "Filter:", 
            lengthMenu: "Show _MENU_ riders" 
          },
          autoWidth: false,
          columnDefs: [
            { width: "60px",  targets: 0 },
            { width: "50px",  targets: 1 },
            { width: "240px", targets: 2 },
            { width: "100px", targets: 3 },
            { width: "92px",  targets: 4 },
            { width: "160px", targets: 5 },
            { width: "220px", targets: 6 },
            { width: "52px",  targets: 7 },
            { width: "92px",  targets: 8 },
            { width: "62px",  targets: 9 },
            { width: "92px",  targets: 10 },
            { width: "160px", targets: 11 },
            { width: "220px", targets: 12 },
            { width: "52px",  targets: 13 },
            { width: "92px",  targets: 14 },
            { width: "62px",  targets: 15 },
            { width: "92px",  targets: 16 },
            { width: "160px", targets: 17 },
            { width: "220px", targets: 18 },
            { width: "52px",  targets: 19 },
            { width: "92px",  targets: 20 },
            { width: "62px",  targets: 21 },
            { width: "88px",  targets: 22 },
            { width: "96px",  targets: 23 },
            // Numeric sorting for Score (handles comma & 2 decimals)
            {
              targets: 3,
              type: 'num',
              render: function(data, type) {
                if (type === 'sort' || type === 'type') {
                  return parseFloat(data.replace(/[^\d.-]/g, '').replace(',', '.'));
                }
                return data;
              }
            }
          ]
        });
      });
  </script>
</body>
</html>
