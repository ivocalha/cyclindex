<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rider Score – Cyclindex</title>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/5.0.1/css/fixedColumns.dataTables.css">

  <style>
    @font-face {
      font-family: 'Suissnord';
      src: url('Suissnord.otf') format('opentype');
      font-display: swap;
    }

    :root {
      --nav-height: 71px;
      --footer-height: 64px;
      --pill-radius: 0.7rem;
      --pill-bg: rgba(59,130,246,0.35);
      --neon-blue: #3b82f6;
      --header-blue: #1a2f55;
      --header-radius: 14px;
      --fade-duration: 0.4s;
    }

    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      background: #0f172a;
      color: white;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .nav-bar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--nav-height);
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(12px);
      display: flex; align-items: center;
      padding: 1rem 2rem;
      z-index: 3000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .nav-links {
      display: flex;
      gap: 2rem;
      width: 100%;
      justify-content: center;
    }
    .nav-links a {
      font-family: 'Suissnord', sans-serif;
      text-decoration: none;
      font-size: 1.05rem;
      color: white;
      padding: 0.45rem 0.9rem;
      border-radius: var(--pill-radius);
      transition: all .18s;
    }
    .nav-links a.active,
    .nav-links a:hover {
      background: var(--pill-bg);
      transform: translateY(-2px);
    }

    .table-wrapper {
      position: fixed;
      top: var(--nav-height);
      left: 0; right: 0;
      bottom: var(--footer-height);
      padding: 10px 18px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    table.dataTable {
      { width: 100% !important; border-collapse: separate; border-spacing: 0; }
    table.dataTable thead th { background: var(--header-blue); color: white; position: sticky; top: 0; z-index: 50; }

    /* Fixed columns styling */
    table.dataTable th.DTFC_Cloned,
    table.dataTable td.DTFC_Cloned {
      background: rgba(26,47,85,0.98) !important;
      box-shadow: 4px 0 12px rgba(0,0,0,0.4);
      z-index: 60;
    }

    #riderTable thead th:first-child { border-top-left-radius: var(--header-radius); }
    #riderTable thead th:nth-child(4)  { border-top-right-radius: var(--header-radius); }

    #riderTable tbody td {
      font-size: .89rem;
      white-space: nowrap;
      text-align: center;
      padding: 0.55rem 0.5rem !important;
    }
    #riderTable tbody tr:hover td { background: rgba(59,130,246,0.12) !important; }
    #riderTable tbody tr:hover td.DTFC_Cloned { background: rgba(59,130,246,0.18) !important; }

    .fixed-bottom-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: var(--footer-height);
      background: rgba(15,23,42,0.95);
      backdrop-filter: blur(12px);
      display: flex; align-items: center;
      justify-content: space-between;
      padding: 0 1.25rem;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.45);
      z-index: 2900;
    }
    .footer-left, .footer-center, .footer-right { display: flex; align-items: center; gap: 12px; }
    .footer-center { flex: 1; justify-content: center; gap: 16px; }

    .entries-pill {
      background: var(--pill-bg);
      padding: 6px 14px;
      border-radius: var(--pill-radius);
      font-size: 0.95rem;
    }

    .search-wrap {
      display: flex; align-items: center; gap: 8px;
    }
    .search-wrap svg { width: 18px; height: 18px; }
    .search-wrap svg circle,
    .search-wrap svg line { stroke: var(--neon-blue); stroke-width: 2; }
    .search-wrap input {
      width: 220px;
      padding: 6px 10px;
      border-radius: var(--pill-radius);
      background: rgba(255,255,255,0.08);
      border: none;
      outline: none;
      color: white;
    }

    .flag{width:26px;height:18px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.5);object-fit:cover;transition:transform .2s;}
    .flag:hover{transform:scale(1.6);}
    .flag-name{position:absolute;background:rgba(0,0,0,0.92);color:white;font-size:11px;padding:3px 7px;border-radius:4px;opacity:0;transition:opacity .2s;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:6px;}
    .flag-container{position:relative;display:inline-block;}
    .flag-container:hover .flag-name{opacity:1;}

    .season-label{font-weight:600;opacity:0.85;}
    #season-select, #spec-select{
      background:rgba(15,23,42,0.8);border:1px solid rgba(255,255,255,0.3);
      border-radius:0.5rem;padding:0.4rem 0.8rem;color:white;font-size:0.9rem;
      outline:none;cursor:pointer;transition:all .2s;
    }
    #season-select:hover, #spec-select:hover{border-color:#3b82f6;}
    #season-select:focus, #spec-select:focus{border-color:#3b82f6;background:rgba(255,255,255,0.15);}

    .pagination-pill {
      background: var(--pill-bg) !important;
      color: white !important;
      font-weight: 600;
    }

    @media(max-width:720px) {
      .search-wrap input { width: 140px; }
    }
  </style>
</head>
<body>

<nav class="nav-bar">
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="results-log.html">Results</a>
    <a href="rider-score.html" class="active">Riders</a>
    <a href="team-score.html">Teams</a>
    <a href="nation-score.html">Nations</a>
    <a href="how-it-works.html">How It Works</a>
  </div>
</nav>

<div class="table-wrapper">
  <table id="riderTable" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nation</th>
        <th>Rider</th>
        <th title="Rider Score">Score</th>
        <th>Date1</th>
        <th>Team1</th>
        <th>Race1</th>
        <th>Rk1</th>
        <th>T1</th>
        <th>L1</th>
        <th>Date2</th>
        <th>Team2</th>
        <th>Race2</th>
        <th>Rk2</th>
        <th>T2</th>
        <th>L2</th>
        <th>Date3</th>
        <th>Team3</th>
        <th>Race3</th>
        <th>Rk3</th>
        <th>T3</th>
        <th>L3</th>
        <th>TRk</th>
        <th>NRk</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="fixed-bottom-bar">
  <div class="footer-left">
    <span class="season-label">Season</span>
    <select id="season-select"><option>Loading seasons...</option></select>
    <span class="season-label">Spec:</span>
    <select id="spec-select"><option>Loading specs...</option></select>
  </div>
  <div class="footer-center">
    <div id="pagContainer"></div>
    <span id="infoContainer" class="entries-pill"></span>
  </div>
  <div class="footer-right">
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none">
        <circle cx="11" cy="11" r="7"/>
        <line x1="16.65" y1="16.65" x2="21" y2="21" stroke-linecap="round"/>
      </svg>
      <input id="footerSearch" placeholder="Search…">
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/dataTables.fixedColumns.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const countryFlags = {
  "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao","Antigua and Barbuda":"ag","Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at","Azerbaijan":"az",
  "Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb","Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bermuda":"bm","Bhutan":"bt","Bolivia":"bo",
  "Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn","Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cambodia":"kh","Cameroon":"cm","Canada":"ca",
  "Cape Verde":"cv","Cayman Islands":"ky","Central African Republic":"cf","Chad":"td","Chile":"cl","China":"cn","Colombia":"co","Comoros":"km","Congo":"cg","Costa Rica":"cr",
  "Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czech Republic":"cz","Denmark":"dk","Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Ecuador":"ec","Egypt":"eg",
  "El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er","Estonia":"ee","Eswatini":"sz","Ethiopia":"et","Fiji":"fj","Finland":"fi","France":"fr","Gabon":"ga",
  "Gambia":"gm","Georgia":"ge","Germany":"de","Ghana":"gh","Greece":"gr","Grenada":"gd","Guatemala":"gt","Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy",
  "Haiti":"ht","Honduras":"hn","Hong Kong":"hk","Hungary":"hu","Iceland":"is","India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq","Ireland":"ie",
  "Israel":"il","Italy":"it","Ivory Coast":"ci","Jamaica":"jm","Japan":"jp","Jordan":"jo","Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki","Kosovo":"xk",
  "Kuwait":"kw","Kyrgyzstan":"kg","Laos":"la","Latvia":"lv","Lebanon":"lb","Lesotho":"ls","Liberia":"lr","Libya":"ly","Liechtenstein":"li","Lithuania":"lt",
  "Luxembourg":"lu","Madagascar":"mg","Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml","Malta":"mt","Marshall Islands":"mh","Mauritania":"mr",
  "Mauritius":"mu","Mexico":"mx","Moldova":"md","Monaco":"mc","Mongolia":"mn","Montenegro":"me","Morocco":"ma","Mozambique":"mz","Myanmar":"mm",
  "Namibia":"na","Nauru":"nr","Nepal":"np","Netherlands":"nl","New Zealand":"nz","Nicaragua":"ni","Niger":"ne","Nigeria":"ng","North Macedonia":"mk",
  "Norway":"no","Oman":"om","Pakistan":"pk","Palau":"pw","Palestine":"ps","Panama":"pa","Papua New Guinea":"pg","Paraguay":"py","Peru":"pe",
  "Philippines":"ph","Poland":"pl","Portugal":"pt","Qatar":"qa","Romania":"ro","Russia":"ru","Rwanda":"rw","Saint Kitts and Nevis":"kn",
  "Saint Lucia":"lc","Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm","Sao Tome and Principe":"st","Saudi Arabia":"sa",
  "Senegal":"sn","Serbia":"rs","Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg","Slovakia":"sk","Slovenia":"si","Solomon Islands":"sb",
  "Somalia":"so","South Africa":"za","South Korea":"kr","South Sudan":"ss","Spain":"es","Sri Lanka":"lk","Sudan":"sd","Suriname":"sr",
  "Sweden":"se","Switzerland":"ch","Syria":"sy","Taiwan":"tw","Tajikistan":"tj","Tanzania":"tz","Thailand":"th","Timor-Leste":"tl",
  "Togo":"tg","Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn","Turkey":"tr","Turkmenistan":"tm","Tuvalu":"tv","Uganda":"ug",
  "Ukraine":"ua","United Arab Emirates":"ae","United Kingdom":"gb","Great Britain":"gb","England":"gb-eng","Scotland":"gb-sct","Wales":"gb-wls",
  "United States":"us","Uruguay":"uy","Uzbekistan":"uz","Vanuatu":"vu","Vatican City":"va","Venezuela":"ve","Vietnam":"vn",
  "Yemen":"ye","Zambia":"zm","Zimbabwe":"zw"
};

const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/rider-score.csv";

function smallSpan(txt){ 
  const s=document.createElement('span'); 
  s.textContent=txt; 
  s.className='px-2 opacity-60'; 
  return s; 
}

function buildPagination(c, info, table) {
  c.innerHTML = "";
  const page = info.page;
  const last = info.pages - 1;
  const mk = (label, disabled, target, active=false) => {
    const b = document.createElement('button');
    b.textContent = label;
    b.className = 'px-3 py-1.5 rounded text-sm transition-all hover:bg-white/10';
    if (active) b.classList.add('pagination-pill');
    if (!disabled) b.onclick = () => table.page(target).draw('page');
    else b.disabled = true;
    return b;
  };
  c.appendChild(mk('Previous', page===0, page-1));
  c.appendChild(mk('1', false, 0, page===0));
  if (page>3) c.appendChild(smallSpan('...'));
  for (let i=Math.max(1,page-2); i<=Math.min(last-1,page+2); i++) 
    c.appendChild(mk(String(i+1), false, i, i===page));
  if (page<last-3) c.appendChild(smallSpan('...'));
  if (info.pages>1) c.appendChild(mk(String(last+1), false, last, page===last));
  c.appendChild(mk('Next', page===last, page+1));
}

function updateInfo(c, info) {
  c.textContent = `Showing ${info.start+1} to ${info.end} of ${info.recordsDisplay} riders`;
}

let dataTable = null;

function loadTable(season, spec) {
  fetch(CSV_URL)
    .then(r => r.text())
    .then(text => {
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

      const parsed = Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        delimiter: ";",
        transformHeader: h => h.trim(),
        transform: v => v ? v.toString().trim() : ""
      });

      const filtered = parsed.data.filter(row => 
        String(row.Season) === String(season) && String(row.Spec) === String(spec)
      );

      const displayColumns = ["Rank","Country","Rider","Score","Date1","Team1","Event1","Rank1","Results_Type1","Level1",
        "Date2","Team2","Event2","Rank2","Results_Type2","Level2",
        "Date3","Team3","Event3","Rank3","Results_Type3","Level3",
        "rider_team_rank","rider_country_rank"];

      const data = filtered.map(row => {
        const countryName = row.Country || "";
        const code = countryFlags[countryName] || "";
        const flagHTML = code 
          ? `<div class="flag-container"><img class="flag" src="https://flagcdn.com/w40/${code}.png" alt="${countryName}"><div class="flag-name">${countryName}</div></div>`
          : countryName;

        return displayColumns.map(col => {
          if (col === "Country") return flagHTML;
          let val = row[col] ?? "";
          if (col === "Score" && val) {
            val = parseFloat(String(val).replace(",", ".")).toFixed(2).replace(".", ",");
          }
          return val;
        });
      });

      // Destroy old instance completely
      if (dataTable) {
        dataTable.fixedColumns().destroy();
        dataTable.destroy();
      }

      dataTable = $('#riderTable').DataTable({
        data: data,
        dom: 't',
        pageLength: 100,
        lengthMenu: [50, 100, 200, 500],
        order: [[0, 'asc']],
        scrollX: true,
        fixedColumns: {
          left: 4
        },
        destroy: true
      });

      const pag = document.getElementById('pagContainer');
      const info = document.getElementById('infoContainer');
      const search = document.getElementById('footerSearch');
      search.value = "";

      dataTable.on('draw', () => {
        const meta = dataTable.page.info();
        buildPagination(pag, meta, dataTable);
        updateInfo(info, meta);
      });

      search.addEventListener('input', () => dataTable.search(search.value).draw());

      // Ensure layout after load
      setTimeout(() => dataTable.columns.adjust().fixedColumns().relayout(), 150);

      dataTable.draw();
    });
}

// Initialise seasons & specs
fetch(CSV_URL)
  .then(r => r.text())
  .then(text => {
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const parsed = Papa.parse(text, { header: true, delimiter: ";", skipEmptyLines: true });

    const seasons = [...new Set(parsed.data.map(r => r.Season).filter(Boolean))]
      .sort((a,b) => b - a);

    const specs = [...new Set(['OVERALL', ...parsed.data.map(r => r.Spec).filter(Boolean)])]
      .sort((a,b) => a==='OVERALL' ? -1 : b==='OVERALL' ? 1 : a.localeCompare(b));

    const seasonSelect = document.getElementById('season-select');
    const specSelect = document.getElementById('spec-select');

    seasonSelect.innerHTML = seasons.map(s => `<option value="${s}">${s}</option>`).join('');
    specSelect.innerHTML = specs.map(s => `<option value="${s}" ${s==='OVERALL'?'selected':''}>${s}</option>`).join('');

    seasonSelect.value = seasons[0];
    loadTable(seasons[0], 'OVERALL');

    seasonSelect.onchange = () => loadTable(seasonSelect.value, specSelect.value);
    specSelect.onchange = () => loadTable(seasonSelect.value, specSelect.value);
  });
</script>

</body>
</html>
