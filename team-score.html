<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">
  <title>Team Score – Cyclindex</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.2/css/buttons.tailwindcss.css">
  <style>
    @font-face { font-family: 'Suissnord'; src: url('Suissnord.otf') format('opentype'); font-display: swap; }
    body { background:#0f172a; color:white; margin:0; padding:0; }
    h1 { font-family: 'Suissnord', sans-serif; font-size: clamp(4.5rem, 9vw, 7rem); text-align:center; padding:10rem 0 4rem; background:linear-gradient(to bottom,#1e3a8a,#0f172a); text-shadow:0 8px 40px #000; margin:0; }

    .table-wrapper { position: relative; max-height: 80vh; overflow: auto; }
    #teamTable { background:rgba(255,255,255,0.08); backdrop-filter:blur(24px); border-radius:2rem; overflow:hidden; box-shadow:0 40px 120px rgba(0,0,0,0.95); }
    #teamTable thead th { background:#1e40af !important; font-family: system-ui, -apple-system, sans-serif !important; font-size:1.15rem !important; padding:1rem 0.5rem !important; text-align:center; font-weight:600; position: sticky; top:0; z-index:10; }
    #teamTable tbody td { padding:0.75rem 0.5rem !important; text-align:center; vertical-align:middle; font-size:0.92rem; line-height:1.3; }
    #teamTable tbody tr:hover { background:rgba(59,130,246,0.28) !important; }

    .flag-img { width:26px; height:19.5px; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,0.6); transition:transform .2s; }
    .flag-img:hover { transform:scale(2); }
    .tooltip { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.94); color:white; padding:7px 11px; border-radius:6px; font-size:0.86rem; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; margin-bottom:6px; z-index:1000; }
    .flag-container:hover .tooltip { opacity:1; }
    .flag-container { position:relative; display:inline-block; cursor:help; }

    .nav-bar { background: rgba(15,23,42,0.9); backdrop-filter: blur(12px); padding: 1rem 2rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .nav-links { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
    .nav-links a { color: white; font-family: 'Suissnord', sans-serif; font-size: 1.1rem; text-decoration: none; padding: 0.5rem 1rem; border-radius: 0.8rem; transition: all 0.3s; }
    .nav-links a:hover { background: rgba(59,130,246,0.4); transform: translateY(-2px); }

    .no-data { text-align:center; padding:2.5rem; font-size:1.1rem; color:#e2e8f0; }
    .no-data strong { color:#fbbf24; }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav class="nav-bar">
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="rider-score.html">Rider Score</a>
      <a href="team-score.html" style="background:rgba(59,130,246,0.4);">Team Score</a>
      <a href="nation-score.html">Nation Score</a>
      <a href="how-it-works.html">How It Works</a>
      <a href="results-log.html">Results Log</a>
    </div>
  </nav>

  <h1>TEAM SCORE</h1>

  <div class="container mx-auto px-4 pb-12">
    <div class="table-wrapper">
      <table id="teamTable" class="display nowrap" style="width:100%">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Nation</th>
            <th>Team</th>
            <th>Riders</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/dataTables.buttons.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.colVis.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/team-score.csv";

    // FULL 249+ COUNTRY LIST (ISO 3166-1 alpha-2)
    const countryFlags = {
      "Afghanistan":"af","Albania":"al","Algeria":"dz","American Samoa":"as","Andorra":"ad","Angola":"ao","Anguilla":"ai","Antarctica":"aq","Antigua and Barbuda":"ag",
      "Argentina":"ar","Armenia":"am","Aruba":"aw","Australia":"au","Austria":"at","Azerbaijan":"az","Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb",
      "Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bermuda":"bm","Bhutan":"bt","Bolivia":"bo","Bonaire":"bq","Bosnia and Herzegovina":"ba","Botswana":"bw",
      "Bouvet Island":"bv","Brazil":"br","British Indian Ocean Territory":"io","Brunei":"bn","Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cabo Verde":"cv","Cambodia":"kh",
      "Cameroon":"cm","Canada":"ca","Cayman Islands":"ky","Central African Republic":"cf","Chad":"td","Chile":"cl","China":"cn","Christmas Island":"cx","Cocos (Keeling) Islands":"cc",
      "Colombia":"co","Comoros":"km","Congo":"cg","Congo (DRC)":"cd","Cook Islands":"ck","Costa Rica":"cr","Croatia":"hr","Cuba":"cu","Curaçao":"cw","Cyprus":"cy",
      "Czechia":"cz","Côte d'Ivoire":"ci","Denmark":"dk","Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Ecuador":"ec","Egypt":"eg","El Salvador":"sv","Equatorial Guinea":"gq",
      "Eritrea":"er","Estonia":"ee","Eswatini":"sz","Ethiopia":"et","Falkland Islands":"fk","Faroe Islands":"fo","Fiji":"fj","Finland":"fi","France":"fr","French Guiana":"gf",
      "French Polynesia":"pf","French Southern Territories":"tf","Gabon":"ga","Gambia":"gm","Georgia":"ge","Germany":"de","Ghana":"gh","Gibraltar":"gi","Greece":"gr",
      "Greenland":"gl","Grenada":"gd","Guadeloupe":"gp","Guam":"gu","Guatemala":"gt","Guernsey":"gg","Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy","Haiti":"ht",
      "Heard Island and McDonald Islands":"hm","Honduras":"hn","Hong Kong":"hk","Hungary":"hu","Iceland":"is","India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq",
      "Ireland":"ie","Isle of Man":"im","Israel":"il","Italy":"it","Jamaica":"jm","Japan":"jp","Jersey":"je","Jordan":"jo","Kazakhstan":"kz","Kenya":"ke",
      "Kiribati":"ki","Kuwait":"kw","Kyrgyzstan":"kg","Laos":"la","Latvia":"lv","Lebanon":"lb","Lesotho":"ls","Liberia":"lr","Libya":"ly","Liechtenstein":"li",
      "Lithuania":"lt","Luxembourg":"lu","Macao":"mo","Madagascar":"mg","Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml","Malta":"mt","Marshall Islands":"mh",
      "Martinique":"mq","Mauritania":"mr","Mauritius":"mu","Mayotte":"yt","Mexico":"mx","Micronesia":"fm","Moldova":"md","Monaco":"mc","Mongolia":"mn","Montenegro":"me",
      "Montserrat":"ms","Morocco":"ma","Mozambique":"mz","Myanmar":"mm","Namibia":"na","Nauru":"nr","Nepal":"np","Netherlands":"nl","New Caledonia":"nc","New Zealand":"nz",
      "Nicaragua":"ni","Niger":"ne","Nigeria":"ng","Niue":"nu","Norfolk Island":"nf","North Korea":"kp","North Macedonia":"mk","Northern Mariana Islands":"mp","Norway":"no",
      "Oman":"om","Pakistan":"pk","Palau":"pw","Palestine":"ps","Panama":"pa","Papua New Guinea":"pg","Paraguay":"py","Peru":"pe","Philippines":"ph","Pitcairn":"pn",
      "Poland":"pl","Portugal":"pt","Puerto Rico":"pr","Qatar":"qa","Romania":"ro","Russia":"ru","Rwanda":"rw","Réunion":"re","Saint Barthélemy":"bl","Saint Helena":"sh",
      "Saint Kitts and Nevis":"kn","Saint Lucia":"lc","Saint Martin":"mf","Saint Pierre and Miquelon":"pm","Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm",
      "Sao Tome and Principe":"st","Saudi Arabia":"sa","Senegal":"sn","Serbia":"rs","Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg","Sint Maarten":"sx","Slovakia":"sk",
      "Slovenia":"si","Solomon Islands":"sb","Somalia":"so","South Africa":"za","South Georgia and the South Sandwich Islands":"gs","South Korea":"kr","South Sudan":"ss",
      "Spain":"es","Sri Lanka":"lk","Sudan":"sd","Suriname":"sr","Svalbard and Jan Mayen":"sj","Sweden":"se","Switzerland":"ch","Syria":"sy","Taiwan":"tw","Tajikistan":"tj",
      "Tanzania":"tz","Thailand":"th","Timor-Leste":"tl","Togo":"tg","Tokelau":"tk","Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn","Turkey":"tr","Turkmenistan":"tm",
      "Turks and Caicos Islands":"tc","Tuvalu":"tv","Uganda":"ug","Ukraine":"ua","United Arab Emirates":"ae","United Kingdom":"gb","Great Britain":"gb","United States":"us",
      "United States Minor Outlying Islands":"um","Uruguay":"uy","Uzbekistan":"uz","Vanuatu":"vu","Vatican City":"va","Venezuela":"ve","Vietnam":"vn","Virgin Islands (British)":"vg",
      "Virgin Islands (U.S.)":"vi","Wallis and Futuna":"wf","Western Sahara":"eh","Yemen":"ye","Zambia":"zm","Zimbabwe":"zw"
    };

    // Robust parser: "123,45" → 123.45
    const parseScore = txt => parseFloat((txt || '').toString().trim().replace(',', '.')) || 0;

    fetch(CSV_URL)
      .then(r => r.text())
      .then(text => {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // Strip BOM

        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,   // ← Critical: avoid breaking on commas
          delimiter: ";",
          trimHeaders: true,
          transformHeader: h => h.trim(),
          transform: v => v ? v.trim() : ""
        });

        const columns = ["Rank","Country","Team","Riders","Total Score"];

        // Filter: only teams with score >= 41
        const filtered = parsed.data.filter(row => {
          const score = parseScore(row["Total Score"]);
          return row.Rank && row.Team && score >= 41;
        });

        // Build table data
        const tableData = filtered.map(row => {
          const country = row["Country"] || "";
          const code = countryFlags[country] || "";
          const flagHtml = code
            ? `<div class="flag-container">
                 <img src="https://flagcdn.com/48x36/${code}.png" class="flag-img" alt="${country}" loading="lazy">
                 <div class="tooltip">${country}</div>
               </div>`
            : country;

          const score = parseScore(row["Total Score"]);
          return columns.map(col => {
            if (col === "Country") return flagHtml;
            if (col === "Total Score") return score.toFixed(2);
            return row[col] ?? "";
          });
        });

        const $tbody = $('#teamTable tbody');

        // === FALLBACK: No team ≥ 41.00 ===
        if (tableData.length === 0) {
          const allScores = parsed.data
            .map(r => parseScore(r["Total Score"]))
            .filter(s => s > 0);
          const maxScore = allScores.length ? Math.max(...allScores).toFixed(2) : "0.00";

          $tbody.html(`
            <tr>
              <td colspan="5" class="no-data">
                <div><strong>No teams have reached 41.00 yet</strong></div>
                <div class="mt-2 text-yellow-300">Current highest: <strong>${maxScore}</strong></div>
                <div class="mt-1 text-sm text-gray-400">More race results needed to activate ranking.</div>
              </td>
            </tr>
          `);
          return;
        }

        // === RENDER DATATABLE ===
        $('#teamTable').DataTable({
          data: tableData,
          columns: [
            { title: "Rank" },
            { title: "Nation" },
            { title: "Team" },
            { title: "Riders" },
            { title: "Score" }
          ],
          pageLength: 100,
          lengthMenu: [50, 100, 250],
          order: [[0, 'asc']],
          scrollX: true,
          scrollY: '60vh',
          scrollCollapse: true,
          colReorder: true,
          dom: 'Bfrtip',
          buttons: ['colvis'],
          language: { search: "Search teams:", lengthMenu: "Show _MENU_ teams" },
          columnDefs: [
            { width: "70px",  targets: 0 },
            { width: "60px",  targets: 1 },
            { width: "320px", targets: 2 },
            { width: "90px",  targets: 3 },
            { width: "110px", targets: 4 }
          ]
        });
      })
      .catch(err => {
        $('#teamTable tbody').html('<tr><td colspan="5" class="no-data text-red-400">Failed to load data. Check internet or GitHub.</td></tr>');
        console.error("CSV load failed:", err);
      });
  </script>
</body>
</html>
