<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">
  <title>Results Log – Cyclindex</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.2/css/buttons.tailwindcss.css">
  <style>
    @font-face { font-family: 'Suissnord'; src: url('Suissnord.otf') format('opentype'); font-display: swap; }
    body { background:#0f172a; color:white; margin:0; padding:0; }
    h1 { 
      font-family: 'Suissnord', sans-serif; 
      font-size: clamp(4.5rem, 9vw, 7rem); 
      text-align:center; 
      padding:10rem 0 4rem; 
      background:linear-gradient(to bottom,#1e3a8a,#0f172a); 
      text-shadow:0 8px 40px #000; 
      margin:0;
    }
    .container { padding:2rem 3vw 12rem; max-width:2800px; margin:0 auto; }
    #resultsTable {
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(24px);
      border-radius:2rem;
      overflow:hidden;
      box-shadow:0 40px 120px rgba(0,0,0,0.95);
      font-size: 0.92rem !important;
    }
    #resultsTable thead th {
      background:#1e40af !important;
      font-family:'Suissnord',sans-serif;
      font-size:1.18rem !important;
      padding:1.1rem 0.6rem !important;
      text-align:center;
      font-weight:bold;
    }
    #resultsTable tbody td {
      padding:0.75rem 0.5rem !important;
      text-align:center;
      vertical-align:middle;
      font-size: 0.92rem;
    }
    #resultsTable tbody tr:hover {
      background:rgba(59,130,246,0.28) !important;
    }
    .flag-img {
      width: 26px;
      height: 19.5px;
      border-radius: 3px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.6);
      transition: transform 0.2s;
      display: block;
    }
    .flag-img:hover { transform: scale(1.7); }
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.92);
      color: white;
      padding: 7px 11px;
      border-radius: 6px;
      font-size: 0.88rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      margin-bottom: 6px;
      z-index: 1000;
    }
    .flag-container:hover .tooltip { opacity: 1; }
    .flag-container { position: relative; display: inline-block; }
  </style>
</head>
<body>

  <h1>RESULTS LOG</h1>

  <div class="container">
    <table id="resultsTable" class="display nowrap" style="width:100%">
      <thead>
        <tr>
          <th>Date</th>
          <th>Country</th>
          <th>Rider</th>
          <th>Team</th>
          <th>Competition</th>
          <th>Class</th>
          <th>Rank</th>
          <th>Result Type</th>
          <th>UCI Points</th>
          <th>Level</th>
          <th>Score</th>
          <th>Season Result Rank</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/dataTables.buttons.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.colVis.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.html5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv";

    // COMPLETE WORLD LIST – ALL 200+ COUNTRIES (including Ecuador, Uzbekistan, Czechia, Venezuela, etc.)
    const countryFlags = {
      "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao",
      "Antigua and Barbuda":"ag","Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at",
      "Azerbaijan":"az","Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb",
      "Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bhutan":"bt",
      "Bolivia":"bo","Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn",
      "Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cabo Verde":"cv","Cambodia":"kh",
      "Cameroon":"cm","Canada":"ca","Central African Republic":"cf","Chad":"td","Chile":"cl",
      "China":"cn","Colombia":"co","Comoros":"km","Congo (Brazzaville)":"cg","Congo (Kinshasa)":"cd",
      "Costa Rica":"cr","Côte d'Ivoire":"ci","Croatia":"hr","Cuba":"cu","Cyprus":"cy",
      "Czechia":"cz","Czech Republic":"cz","Denmark":"dk","Djibouti":"dj","Dominica":"dm","Dominican Republic":"do",
      "Ecuador":"ec","Egypt":"eg","El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er",
      "Estonia":"ee","Eswatini":"sz","Ethiopia":"et","Fiji":"fj","Finland":"fi",
      "France":"fr","Gabon":"ga","Gambia":"gm","Georgia":"ge","Germany":"de",
      "Ghana":"gh","Greece":"gr","Grenada":"gd","Guatemala":"gt","Guinea":"gn",
      "Guinea-Bissau":"gw","Guyana":"gy","Haiti":"ht","Honduras":"hn","Hungary":"hu",
      "Iceland":"is","India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq",
      "Ireland":"ie","Israel":"il","Italy":"it","Jamaica":"jm","Japan":"jp",
      "Jordan":"jo","Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki","Kosovo":"xk",
      "Kuwait":"kw","Kyrgyzstan":"kg","Laos":"la","Latvia":"lv","Lebanon":"lb",
      "Lesotho":"ls","Liberia":"lr","Libya":"ly","Liechtenstein":"li","Lithuania":"lt",
      "Luxembourg":"lu","Madagascar":"mg","Malawi":"mw","Malaysia":"my","Maldives":"mv",
      "Mali":"ml","Malta":"mt","Marshall Islands":"mh","Mauritania":"mr","Mauritius":"mu",
      "Mexico":"mx","Micronesia":"fm","Moldova":"md","Monaco":"mc","Mongolia":"mn",
      "Montenegro":"me","Morocco":"ma","Mozambique":"mz","Myanmar":"mm","Namibia":"na",
      "Nauru":"nr","Nepal":"np","Netherlands":"nl","New Zealand":"nz","Nicaragua":"ni",
      "Niger":"ne","Nigeria":"ng","North Korea":"kp","North Macedonia":"mk","Norway":"no",
      "Oman":"om","Pakistan":"pk","Palau":"pw","Palestine":"ps","Panama":"pa",
      "Papua New Guinea":"pg","Paraguay":"py","Peru":"pe","Philippines":"ph","Poland":"pl",
      "Portugal":"pt","Qatar":"qa","Romania":"ro","Russia":"ru","Rwanda":"rw",
      "Saint Kitts and Nevis":"kn","Saint Lucia":"lc","Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm",
      "Sao Tome and Principe":"st","Saudi Arabia":"sa","Senegal":"sn","Serbia":"rs","Seychelles":"sc",
      "Sierra Leone":"sl","Singapore":"sg","Slovakia":"sk","Slovenia":"si","Solomon Islands":"sb",
      "Somalia":"so","South Africa":"za","South Korea":"kr","South Sudan":"ss","Spain":"es",
      "Sri Lanka":"lk","Sudan":"sd","Suriname":"sr","Sweden":"se","Switzerland":"ch",
      "Syria":"sy","Taiwan":"tw","Tajikistan":"tj","Tanzania":"tz","Thailand":"th",
      "Timor-Leste":"tl","Togo":"tg","Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn",
      "Turkey":"tr","Turkmenistan":"tm","Tuvalu":"tv","Uganda":"ug","Ukraine":"ua",
      "United Arab Emirates":"ae","United Kingdom":"gb","Great Britain":"gb","England":"gb","Scotland":"gb","Wales":"gb",
      "United States":"us","Uruguay":"uy","Uzbekistan":"uz","Vanuatu":"vu","Vatican City":"va",
      "Venezuela":"ve","Vietnam":"vn","Yemen":"ye","Zambia":"zm","Zimbabwe":"zw"
    };

    fetch(CSV_URL)
      .then(r => r.text())
      .then(text => {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: true,
          delimiter: ";",
          trimHeaders: true,
          transformHeader: h => h.trim(),
          transform: v => v ? v.trim() : ""
        });

        const columnsToShow = [
          "Date","Country","Rider","Team","Competition","Class",
          "Rank","Result Type","UCI Points","Level","Score","Season Result Rank"
        ];

        const tableData = parsed.data
          .filter(r => r.Date && r.Rider)
          .map(row => {
            const country = row["Country"] || "";
            const code = countryFlags[country] || "";
            const flagHtml = code 
              ? `<div class="flag-container">
                   <img src="https://flagcdn.com/48x36/${code}.png" class="flag-img" alt="${country}" loading="lazy">
                   <div class="tooltip">${country}</div>
                 </div>`
              : country;

            return columnsToShow.map(col => col === "Country" ? flagHtml : (row[col] ?? ""));
          });

        $('#resultsTable').DataTable({
          data: tableData,
          columns: columnsToShow.map(title => ({
            title,
            render: function(data, type, row, meta) {
              // ONLY fix sorting for Date column
              if (meta.col === 0 && (type === 'sort' || type === 'type')) {
                const [d, m, y] = data.split('/');
                return y.padStart(4,'0') + m.padStart(2,'0') + d.padStart(2,'0'); // YYYYMMDD
              }
              if (meta.col === 1) return data; // flag HTML
              return data;
            }
          })),
          pageLength: 100,
          lengthMenu: [50, 100, 250, 500],
          order: [[0, 'desc']], // newest first – now 100% correct
          scrollX: true,
          colReorder: true,
          dom: 'Bfrtip',
          buttons: ['colvis', {extend:'csv', text:'Export CSV'}, 'copy'],
          language: { search: "Filter:", lengthMenu: "Show _MENU_ rows" },
          autoWidth: false,
          columnDefs: [
            { width: "90px", targets: 0 },
            { width: "60px", targets: 1 },
            { width: "180px", targets: 2 },
            { width: "160px", targets: 3 },
            { width: "220px", targets: 4 },
            { width: "70px", targets: 5 },
            { width: "60px", targets: 6 },
            { width: "100px", targets: 7 },
            { width: "90px", targets: 8 },
            { width: "70px", targets: 9 },
            { width: "80px", targets: 10 },
            { width: "100px", targets: 11 }
          ]
        });
      });
  </script>
</body>
</html>
