<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Results Log – Cyclindex</title>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">

  <!-- TailwindCSS + DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">

  <style>
    @font-face {
      font-family: 'Suissnord';
      src: url('Suissnord.otf') format('opentype');
      font-display: swap;
    }

    body {
      margin: 0;
      background: #0f172a;
      color: white;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      overflow: hidden; /* Lock page scroll (dashboard mode) */
    }

    /* NAVBAR */
    .nav-bar {
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(12px);
      padding: 1rem 2rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 71px;
      z-index: 2200;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .nav-links {
      display: flex;
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
      gap: 2rem;
    }
    .nav-links a {
      color: white;
      font-family: 'Suissnord', sans-serif;
      font-size: 1.05rem;
      padding: 0.45rem 0.9rem;
      border-radius: 0.7rem;
      text-decoration: none;
      transition: all .18s;
    }
    .nav-links a:hover {
      background: rgba(59,130,246,0.35);
      transform: translateY(-2px);
    }
    .nav-links a.active {
      background: rgba(59,130,246,0.35);
    }

    /* FOOTER BAR */
    .fixed-bottom-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 64px;
      background: rgba(15,23,42,0.95);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.25rem;
      z-index: 2100;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.45);
    }
    .footer-left, .footer-center, .footer-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .footer-center { flex: 1; justify-content: center; }
    .footer-left { min-width: 200px; }
    .footer-right { min-width: 220px; justify-content: flex-end; }

    /* SEARCH */
    .search-wrap { display: flex; align-items: center; gap: 8px; }
    .search-wrap input {
      width: 220px;
      padding: 6px 10px;
      border-radius: 6px;
      background: rgba(255,255,255,0.06);
      border: none;
      outline: none;
      color: white;
    }
    .magnifier {
      width: 18px;
      height: 18px;
      filter: invert(1) grayscale(1) brightness(2);
    }

    /* TABLE WRAPPER (viewport area) */
    .table-wrapper {
      position: fixed;
      top: 71px;
      left: 0;
      right: 0;
      bottom: 64px;
      padding: 10px 18px;
      overflow: hidden;
    }

    /* Force scroll body height */
    .dataTables_scrollBody {
      position: relative !important;
      overflow-y: auto !important;
      overflow-x: auto !important;
      height: calc(100vh - 71px - 64px - 30px) !important;
      max-height: calc(100vh - 71px - 64px - 30px) !important;
    }

    /* HIDE CLONED HEADER */
    #resultsTable thead tr:not(:first-child) { display: none !important; }

    /* TABLE LOOK */
    #resultsTable {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border-radius: 1rem;
      backdrop-filter: blur(18px);
      box-shadow: 0 30px 90px rgba(0,0,0,0.85);
    }
    #resultsTable thead th {
      background: #1e40af !important;
      font-family: 'Suissnord', sans-serif;
      font-size: 1.02rem !important;
      padding: 0.85rem .5rem !important;
      text-align: center;
      font-weight: 700;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    #resultsTable tbody td {
      padding: .55rem .4rem !important;
      font-size: .89rem;
      text-align: center;
      white-space: nowrap;
    }
    #resultsTable tbody tr:hover {
      background: rgba(59,130,246,0.12) !important;
    }

    /* Flags */
    .flag-img {
      width: 22px;
      height: 16px;
      border-radius: 2px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.35);
      transition: transform .18s;
    }
    .flag-img:hover { transform: scale(2.0); }
    .flag-container { display:inline-block; position:relative; }
    .flag-container .tooltip {
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.9);
      color:white;
      padding:6px 10px;
      border-radius:6px;
      font-size:.84rem;
      white-space:nowrap;
      opacity:0;
      transition:opacity .15s;
      margin-bottom:6px;
      pointer-events:none;
      z-index:3000;
    }
    .flag-container:hover .tooltip { opacity:1; }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="nav-bar">
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="results-log.html" class="active">Results Log</a>
      <a href="rider-score.html">Rider Score</a>
      <a href="team-score.html">Team Score</a>
      <a href="nation-score.html">Nation Score</a>
      <a href="how-it-works.html">How It Works</a>
    </div>
  </nav>

  <!-- TABLE WRAPPER -->
  <div class="table-wrapper">
    <table id="resultsTable" class="display nowrap" style="width:100%">
      <thead>
        <tr>
          <th>Date</th>
          <th>Nation</th>
          <th>Rider</th>
          <th>Team</th>
          <th>Race</th>
          <th>Class</th>
          <th>Rank</th>
          <th>Type</th>
          <th>UCI Pts</th>
          <th>Level</th>
          <th><span title="Rider's Season Result Rank">RSRR</span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- FOOTER -->
  <div class="fixed-bottom-bar">
    <div class="footer-left" id="pagContainer"></div>
    <div class="footer-center" id="infoContainer"></div>
    <div class="footer-right">
      <div class="search-wrap">
        <svg class="magnifier" viewBox="0 0 24 24">
          <path d="M11 19a8 8 0 1 1 5.293-14.293A8 8 0 0 1 11 19zm8.707 3.707L18 18"
            stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input id="footerSearch" placeholder="Search…" />
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    /* Full flags list */
    const countryFlags = {
      "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao",
      "Antigua and Barbuda":"ag","Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at",
      "Azerbaijan":"az","Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb",
      "Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bhutan":"bt",
      "Bolivia":"bo","Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn",
      "Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cabo Verde":"cv","Cambodia":"kh",
      "Cameroon":"cm","Canada":"ca","Central African Republic":"cf","Chad":"td","Chile":"cl",
      "China":"cn","Colombia":"co","Comoros":"km","Congo":"cg","Costa Rica":"cr",
      "Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czechia":"cz","Denmark":"dk",
      "Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Ecuador":"ec","Egypt":"eg",
      "El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er","Estonia":"ee","Eswatini":"sz",
      "Ethiopia":"et","Fiji":"fj","Finland":"fi","France":"fr","Gabon":"ga","Gambia":"gm",
      "Georgia":"ge","Germany":"de","Ghana":"gh","Greece":"gr","Grenada":"gd","Guatemala":"gt",
      "Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy","Haiti":"ht","Honduras":"hn",
      "Hungary":"hu","Iceland":"is","India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq",
      "Ireland":"ie","Israel":"il","Italy":"it","Ivory Coast":"ci","Jamaica":"jm","Japan":"jp",
      "Jordan":"jo","Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki","Kosovo":"xk","Kuwait":"kw",
      "Kyrgyzstan":"kg","Laos":"la","Latvia":"lv","Lebanon":"lb","Lesotho":"ls","Liberia":"lr",
      "Libya":"ly","Liechtenstein":"li","Lithuania":"lt","Luxembourg":"lu","Madagascar":"mg",
      "Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml","Malta":"mt","Marshall Islands":"mh",
      "Mauritania":"mr","Mauritius":"mu","Mexico":"mx","Micronesia":"fm","Moldova":"md","Monaco":"mc",
      "Mongolia":"mn","Montenegro":"me","Morocco":"ma","Mozambique":"mz","Myanmar":"mm","Namibia":"na",
      "Nauru":"nr","Nepal":"np","Netherlands":"nl","New Zealand":"nz","Nicaragua":"ni","Niger":"ne",
      "Nigeria":"ng","North Macedonia":"mk","Norway":"no","Oman":"om","Pakistan":"pk",
      "Palau":"pw","Palestine":"ps","Panama":"pa","Papua New Guinea":"pg","Paraguay":"py",
      "Peru":"pe","Philippines":"ph","Poland":"pl","Portugal":"pt","Qatar":"qa","Romania":"ro",
      "Russia":"ru","Rwanda":"rw","Saint Kitts and Nevis":"kn","Saint Lucia":"lc",
      "Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm",
      "Sao Tome and Principe":"st","Saudi Arabia":"sa","Senegal":"sn","Serbia":"rs",
      "Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg","Slovakia":"sk","Slovenia":"si",
      "Solomon Islands":"sb","Somalia":"so","South Africa":"za","South Korea":"kr","South Sudan":"ss",
      "Spain":"es","Sri Lanka":"lk","Sudan":"sd","Suriname":"sr","Sweden":"se","Switzerland":"ch",
      "Syria":"sy","Taiwan":"tw","Tajikistan":"tj","Tanzania":"tz","Thailand":"th",
      "Timor-Leste":"tl","Togo":"tg","Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn",
      "Turkey":"tr","Turkmenistan":"tm","Uganda":"ug","Ukraine":"ua","United Arab Emirates":"ae",
      "United Kingdom":"gb","Great Britain":"gb","United States":"us","Uruguay":"uy",
      "Uzbekistan":"uz","Vanuatu":"vu","Vatican City":"va","Venezuela":"ve","Vietnam":"vn",
      "Yemen":"ye","Zambia":"zm","Zimbabwe":"zw"
    };

    const CSV_URL = 
      "https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv";

    /* Pagination builder (Option D) */
    function buildPagination(container, info, table) {
      container.innerHTML = "";
      const pages = info.pages;
      const page = info.page;

      function pbtn(label, isActive, disabled, click) {
        const b = document.createElement("button");
        b.textContent = label;
        b.className = "px-2 py-1 rounded text-sm hover:bg-white/5";
        if (isActive) b.classList.add("bg-white/10", "font-semibold");
        if (disabled) b.disabled = true;
        if (click) b.onclick = click;
        return b;
      }

      // Prev
      container.appendChild(
        pbtn("Previous", false, page === 0, () => table.page(page - 1).draw("page"))
      );

      const last = pages - 1;

      if (pages <= 7) {
        for (let i = 0; i < pages; i++) {
          container.appendChild(
            pbtn(i + 1, i === page, false, () => table.page(i).draw("page"))
          );
        }
      } else {
        // First
        container.appendChild(
          pbtn(1, page === 0, false, () => table.page(0).draw("page"))
        );

        if (page > 2) {
          const el = document.createElement("span");
          el.textContent = "…";
          el.className = "px-2";
          container.appendChild(el);
        }

        const s = Math.max(1, page - 1);
        const e = Math.min(last - 1, page + 1);
        for (let i = s; i <= e; i++) {
          container.appendChild(
            pbtn(i + 1, i === page, false, () => table.page(i).draw("page"))
          );
        }

        if (page < last - 2) {
          const el2 = document.createElement("span");
          el2.textContent = "…";
          el2.className = "px-2";
          container.appendChild(el2);
        }

        container.appendChild(
          pbtn(last + 1, page === last, false, () => table.page(last).draw("page"))
        );
      }

      // Next
      container.appendChild(
        pbtn("Next", false, page === last, () => table.page(page + 1).draw("page"))
      );
    }

    /* Info builder */
    function updateInfo(container, info) {
      container.textContent =
        `Showing ${info.start + 1} to ${info.end} of ${info.recordsDisplay} entries`;
    }

    /* MAIN INIT */
    fetch(CSV_URL)
      .then(r => r.text())
      .then(text => {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

        const parsed = Papa.parse(text, {
          header: true, skipEmptyLines: true, dynamicTyping: true,
          delimiter: ";", trimHeaders: true,
          transformHeader: h => h.trim(),
          transform: v => v ? v.trim() : ""
        });

        const cols = [
          "Date","Country","Rider","Team","Competition","Class","Rank",
          "Result Type","UCI Points","Level","Season Result Rank"
        ];

        const data = parsed.data
          .filter(r => r.Date && r.Rider)
          .map(row => {
            const country = row["Country"] || "";
            const code = countryFlags[country];
            const flagHTML = code
              ? `<div class="flag-container">
                   <img src="https://flagcdn.com/${code}.svg" class="flag-img">
                   <div class="tooltip">${country}</div>
                 </div>`
              : country;

            return cols.map(c => (c === "Country" ? flagHTML : (row[c] || "")));
          });

        /* CRITICAL: give scrollY in PX so DT creates scroll wrappers */
        const table = $('#resultsTable').DataTable({
          data: data,
          dom: "t", /* no built-in controls */

          scrollY: "200px", /* dummy required */
          scrollX: true,
          scrollCollapse: true,

          pageLength: 100,
          order: [[0, "desc"]],
          autoWidth: false,

          columnDefs: [{
            targets: 0,
            type: "date",
            render: (d, t) => {
              if ((t === "sort" || t === "type") && d.includes("/")) {
                const [day, mon, yr] = d.split("/");
                return `${yr}-${mon.padStart(2,"0")}-${day.padStart(2,"0")}`;
              }
              return d;
            }
          }]
        });

        /* Footer controls */
        const pag = document.getElementById("pagContainer");
        const inf = document.getElementById("infoContainer");
        const search = document.getElementById("footerSearch");

        search.addEventListener("input", () => table.search(search.value).draw());

        table.on("draw", () => {
          const info = table.page.info();
          buildPagination(pag, info, table);
          updateInfo(inf, info);
        });

        table.draw(false);

        /* Apply real height AFTER DT overwrites it */
        setTimeout(() => {
          const body = document.querySelector(".dataTables_scrollBody");
          if (body) {
            body.style.height = "calc(100vh - 71px - 64px - 30px)";
            body.style.maxHeight = "calc(100vh - 71px - 64px - 30px)";
          }
          table.columns.adjust();
        }, 300);
      });
  </script>

</body>
</html>
