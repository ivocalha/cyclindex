<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyclindex Results Log – Flags Updated from CSV</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a5fb4; }
        #searchInput { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #1a5fb4; color: white; }
        tr:hover { background: #f9f9f9; }
        .country { white-space: nowrap; }
        .flag { display: inline-block; width: 20px; height: 15px; margin-right: 6px; vertical-align: middle; border: 1px solid #eee; }
        .pagination { text-align: center; margin: 20px 0; }
        .pagination button { margin: 0 5px; padding: 8px 12px; background: #1a5fb4; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .pagination button:disabled { background: #ccc; cursor: not-allowed; }
        .loading { text-align: center; padding: 20px; color: #666; }
        @media (max-width: 768px) { table { font-size: 0.9em; } .flag { width: 16px; height: 12px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cyclindex Results Log</h1>
        <p>Loaded from <a href="https://github.com/ivocalha/cyclindex/blob/main/results-log.csv" target="_blank">results-log.csv</a> • All countries auto-flagged • Updated: Nov 15, 2025</p>
        
        <input type="text" id="searchInput" placeholder="Search by rider, team, or country..." onkeyup="filterTable()">
        
        <div id="loading" class="loading">Loading CSV data...</div>
        
        <table id="resultsTable" style="display: none;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Rider</th>
                    <th>Team</th>
                    <th>Country</th>
                    <th>Points</th>
                    <!-- Add more <th> if CSV has extra columns -->
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        
        <div id="pagination" class="pagination" style="display: none;"></div>
    </div>

    <script>
        // FULL UPDATED COUNTRY-FLAG MAPPING (ISO 3166-1 alpha-2, extended for your list)
        const countryFlags = {
            "Afghanistan": "af", "Albania": "al", "Algeria": "dz", "Andorra": "ad", "Angola": "ao",
            "Antigua and Barbuda": "ag", "Argentina": "ar", "Armenia": "am", "Australia": "au", "Austria": "at",
            "Azerbaijan": "az", "Bahrain": "bh", "Belarus": "by", "Belgium": "be", "Belize": "bz",
            "Benin": "bj", "Bermuda": "bm", "Bolivia": "bo", "Bosnia and Herzegovina": "ba", "Botswana": "bw",
            "Brazil": "br", "Brunei": "bn", "Bulgaria": "bg", "Burkina Faso": "bf", "Burundi": "bi",
            "Cabo Verde": "cv", "Cambodia": "kh", "Cameroon": "cm", "Canada": "ca", "Chile": "cl",
            "China": "cn", "Colombia": "co", "Comoros": "km", "Congo": "cg", "Costa Rica": "cr",
            "Croatia": "hr", "Cuba": "cu", "Cyprus": "cy", "Czechia": "cz", "Czech Republic": "cz",
            "Denmark": "dk", "Dominican Republic": "do", "Ecuador": "ec", "Egypt": "eg", "El Salvador": "sv",
            "Eritrea": "er", "Estonia": "ee", "Ethiopia": "et", "Finland": "fi", "France": "fr",
            "French Polynesia": "pf", "Germany": "de", "Ghana": "gh", "Great Britain": "gb", "Greece": "gr",
            "Grenada": "gd", "Guam": "gu", "Guatemala": "gt", "Guyana": "gy", "Honduras": "hn",
            "Hong Kong": "hk", "Hungary": "hu", "Indonesia": "id", "Iran": "ir", "Iraq": "iq",
            "Ireland": "ie", "Isle of Man": "im", "Israel": "il", "Italy": "it", "Japan": "jp",
            "Kazakhstan": "kz", "Kenya": "ke", "Kyrgyzstan": "kg", "Laos": "la", "Latvia": "lv",
            "Lithuania": "lt", "Luxembourg": "lu", "Macau": "mo", "Malaysia": "my", "Mali": "ml",
            "Malta": "mt", "Mauritania": "mr", "Mauritius": "mu", "Mexico": "mx", "Mix": "xx", // Fallback for "Mix"
            "Monaco": "mc", "Mongolia": "mn", "Montenegro": "me", "Morocco": "ma", "Namibia": "na",
            "Netherlands": "nl", "New Zealand": "nz", "Nicaragua": "ni", "Niger": "ne", "Nigeria": "ng",
            "North Macedonia": "mk", "Norway": "no", "Oman": "om", "Panama": "pa", "Paraguay": "py",
            "Philippines": "ph", "Poland": "pl", "Portugal": "pt", "Puerto Rico": "pr", "Qatar": "qa",
            "Refugee": "un", "Réunion": "re", "Romania": "ro", "Russia": "ru", "Rwanda": "rw",
            "San Marino": "sm", "Saudi Arabia": "sa", "Serbia": "rs", "Singapore": "sg", "Slovakia": "sk",
            "Slovenia": "si", "South Africa": "za", "South Korea": "kr", "Spain": "es", "Sweden": "se",
            "Switzerland": "ch", "Taiwan": "tw", "Tanzania": "tz", "Thailand": "th", "Trinidad and Tobago": "tt",
            "Turkey": "tr", "Uganda": "ug", "Ukraine": "ua", "United Arab Emirates": "ae", "United Kingdom": "gb",
            "United States": "us", "Uruguay": "uy", "Uzbekistan": "uz", "Vatican": "va", "Venezuela": "ve",
            "Vietnam": "vn", "Virgin Islands": "vi"
        };

        let allRows = [];
        let currentPage = 1;
        const rowsPerPage = 50; // Adjust for performance (original ~20-30 per page)

        // Fetch and parse CSV
        async function loadCSV() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim());
                allRows = lines.slice(1).map(line => {
                    const [date, rider, team, country, points, ...rest] = line.split(',').map(cell => cell.trim().replace(/"/g, '')); // Basic CSV parse (handles quotes)
                    return { date, rider, team, country, points: points || '', details: rest.join(', ') };
                }).filter(row => row.country); // Filter valid rows
                renderTable();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('resultsTable').style.display = 'table';
                document.getElementById('pagination').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').innerHTML = 'Error loading CSV: ' + error.message;
            }
        }

        // Render table with flags
        function renderTable() {
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageRows = allRows.slice(start, end);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = pageRows.map(row => {
                const code = countryFlags[row.country] || 'xx'; // Fallback
                const flagUrl = `https://flagcdn.com/20x15/${code}.png`;
                const flaggedCountry = `<img src="${flagUrl}" alt="${row.country}" class="flag" onerror="this.style.display='none'"> ${row.country}`;
                return `<tr>
                    <td>${row.date}</td>
                    <td>${row.rider}</td>
                    <td>${row.team}</td>
                    <td class="country">${flaggedCountry}</td>
                    <td>${row.points}</td>
                </tr>`;
            }).join('');

            renderPagination();
            filterTable(); // Re-apply search if active
        }

        // Pagination
        function renderPagination() {
            const totalPages = Math.ceil(allRows.length / rowsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                <span>Page ${currentPage} of ${totalPages}</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
            `;
        }

        function changePage(page) {
            if (page < 1 || page > Math.ceil(allRows.length / rowsPerPage)) return;
            currentPage = page;
            renderTable();
        }

        // Search/Filter
        function filterTable() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            let visibleCount = 0;
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(input)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            // Update pagination based on visible (simplified; full impl would re-slice)
            document.querySelector('.pagination span').innerHTML = `Page ${currentPage} (Showing ${visibleCount} results)`;
        }

        // Init
        loadCSV();
    </script>
</body>
</html>
