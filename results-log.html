<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Results Log – Cyclindex</title>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">

  <!-- Tailwind + DataTables CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">

  <style>
    @font-face {
      font-family: 'Suissnord';
      src: url('Suissnord.otf') format('opentype');
      font-display: swap;
    }

    /* Dashboard baseline: no page scroll */
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: white;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      overflow: hidden;
    }

    /* NAVBAR — exact height: 71px */
    .nav-bar {
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(12px);
      padding: 1rem 2rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 71px;
      z-index: 2200;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
    }
    .nav-links { display:flex; justify-content:center; gap:2rem; flex-wrap:wrap; width:100%; }
    .nav-links a {
      color: white;
      font-family: 'Suissnord', sans-serif;
      font-size: 1.05rem;
      text-decoration: none;
      padding: 0.45rem 0.9rem;
      border-radius: 0.7rem;
      transition: all .18s;
    }
    .nav-links a:hover { background: rgba(59,130,246,0.35); transform: translateY(-2px); }
    .nav-links a.active { background: rgba(59,130,246,0.35); }

    /* FIXED FOOTER BAR: full width, height 64px */
    .fixed-bottom-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 64px;
      background: rgba(15,23,42,0.95);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.25rem;
      z-index: 2100;
      gap: 1rem;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.45);
    }
    .footer-left, .footer-center, .footer-right { display:flex; align-items:center; gap:8px; }
    .footer-center { justify-content:center; flex: 1; }
    .footer-left { justify-content:flex-start; min-width: 220px; }
    .footer-right { justify-content:flex-end; min-width: 220px; }

    /* footer search styles (magnifier + input) */
    .search-wrap { display:flex; align-items:center; gap:8px; }
    .search-wrap input {
      width: 220px;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      outline: none;
      background: rgba(255,255,255,0.06);
      color: white;
    }
    .search-wrap .magnifier {
      width: 18px;
      height: 18px;
      display:inline-block;
      opacity: 0.9;
      filter: invert(1) grayscale(1) brightness(2);
    }
    @media (max-width: 720px) {
      .fixed-bottom-bar { flex-direction: column; height: auto; gap: .5rem; padding: .6rem .75rem; }
      .footer-left, .footer-center, .footer-right { width: 100%; justify-content: center; }
      .search-wrap input { width: 100%; }
    }

    /* Table wrapper between navbar and footer */
    .table-wrapper {
      position: fixed;
      top: 71px;
      bottom: 64px;
      left: 0;
      right: 0;
      padding: 10px 18px;
      overflow: hidden;
      z-index: 100;
    }

    /* Force DataTables scroll body to match wrapper height */
    .dataTables_scrollBody {
      position: absolute !important;
      top: 0; bottom: 0; left: 0; right: 0;
      height: auto !important;
      overflow-y: auto !important;
      overflow-x: auto !important;
    }

    /* Hide DataTables' cloned header rows */
    #resultsTable thead tr:not(:first-child) { display: none !important; }

    /* Table surface */
    #resultsTable {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border-radius: 1rem;
      overflow: hidden;
      backdrop-filter: blur(18px);
      box-shadow: 0 30px 90px rgba(0,0,0,0.85);
    }
    #resultsTable thead th {
      background: #1e40af !important;
      font-family: 'Suissnord', sans-serif;
      font-size: 1.02rem !important;
      padding: 0.85rem 0.5rem !important;
      text-align: center;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 50;
      white-space: nowrap;
    }
    #resultsTable tbody td {
      padding: 0.55rem 0.4rem !important;
      text-align: center;
      vertical-align: middle;
      font-size: 0.89rem;
      white-space: nowrap;
    }
    #resultsTable tbody tr:hover { background: rgba(59,130,246,0.12) !important; }

    /* Flags */
    .flag-img { width:22px; height:16px; border-radius:2px; box-shadow:0 1px 3px rgba(0,0,0,0.35); transition:transform .18s; display:inline-block; vertical-align:middle; }
    .flag-img:hover { transform: scale(2.0); }
    .flag-container { position: relative; display:inline-block; cursor:help; }
    .flag-container .tooltip {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.94); color: white; padding: 6px 10px; border-radius: 6px;
      font-size: 0.84rem; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity .15s;
      margin-bottom: 6px; z-index: 2200;
    }
    .flag-container:hover .tooltip { opacity: 1; }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="nav-bar">
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="results-log.html" class="active">Results Log</a>
      <a href="rider-score.html">Rider Score</a>
      <a href="team-score.html">Team Score</a>
      <a href="nation-score.html">Nation Score</a>
      <a href="how-it-works.html">How It Works</a>
    </div>
  </nav>

  <!-- TABLE WRAPPER -->
  <div class="table-wrapper">
    <table id="resultsTable" class="display nowrap" style="width:100%">
      <thead>
        <tr>
          <th>Date</th>
          <th>Nation</th>
          <th>Rider</th>
          <th>Team</th>
          <th>Race</th>
          <th>Class</th>
          <th>Rank</th>
          <th>Type</th>
          <th>UCI Pts</th>
          <th>Level</th>
          <th><span title="Rider's Season Result Rank">RSRR</span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- FIXED FOOTER BAR -->
  <div class="fixed-bottom-bar" id="fixedFooter">
    <div class="footer-left" id="pagContainer"></div>
    <div class="footer-center" id="infoContainer"></div>
    <div class="footer-right" id="searchContainer">
      <div class="search-wrap">
        <!-- magnifier svg -->
        <svg class="magnifier" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M11 19a8 8 0 1 1 5.293-14.293A8 8 0 0 1 11 19zm8.707 3.707L18 18" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input id="footerSearch" placeholder="Search…" aria-label="Search" />
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv";

    // Full country flags list including Great Britain
    const countryFlags = {
      "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao",
      "Antigua and Barbuda":"ag","Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at",
      "Azerbaijan":"az","Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb",
      "Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bhutan":"bt",
      "Bolivia":"bo","Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn",
      "Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cabo Verde":"cv","Cambodia":"kh",
      "Cameroon":"cm","Canada":"ca","Central African Republic":"cf","Chad":"td","Chile":"cl",
      "China":"cn","Colombia":"co","Comoros":"km","Congo":"cg","Costa Rica":"cr",
      "Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czechia":"cz","Denmark":"dk",
      "Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Ecuador":"ec","Egypt":"eg",
      "El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er","Estonia":"ee","Eswatini":"sz",
      "Ethiopia":"et","Fiji":"fj","Finland":"fi","France":"fr","Gabon":"ga",
      "Gambia":"gm","Georgia":"ge","Germany":"de","Ghana":"gh","Greece":"gr",
      "Grenada":"gd","Guatemala":"gt","Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy",
      "Haiti":"ht","Honduras":"hn","Hungary":"hu","Iceland":"is","India":"in",
      "Indonesia":"id","Iran":"ir","Iraq":"iq","Ireland":"ie","Israel":"il",
      "Italy":"it","Ivory Coast":"ci","Jamaica":"jm","Japan":"jp","Jordan":"jo",
      "Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki","Kosovo":"xk","Kuwait":"kw",
      "Kyrgyzstan":"kg","Laos":"la","Latvia":"lv","Lebanon":"lb","Lesotho":"ls",
      "Liberia":"lr","Libya":"ly","Liechtenstein":"li","Lithuania":"lt","Luxembourg":"lu",
      "Madagascar":"mg","Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml",
      "Malta":"mt","Marshall Islands":"mh","Mauritania":"mr","Mauritius":"mu","Mexico":"mx",
      "Micronesia":"fm","Moldova":"md","Monaco":"mc","Mongolia":"mn","Montenegro":"me",
      "Morocco":"ma","Mozambique":"mz","Myanmar":"mm","Namibia":"na","Nauru":"nr",
      "Nepal":"np","Netherlands":"nl","New Zealand":"nz","Nicaragua":"ni","Niger":"ne",
      "Nigeria":"ng","North Macedonia":"mk","Norway":"no","Oman":"om","Pakistan":"pk",
      "Palau":"pw","Palestine":"ps","Panama":"pa","Papua New Guinea":"pg","Paraguay":"py",
      "Peru":"pe","Philippines":"ph","Poland":"pl","Portugal":"pt","Qatar":"qa",
      "Romania":"ro","Russia":"ru","Rwanda":"rw","Saint Kitts and Nevis":"kn","Saint Lucia":"lc",
      "Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm","Sao Tome and Principe":"st","Saudi Arabia":"sa",
      "Senegal":"sn","Serbia":"rs","Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg",
      "Slovakia":"sk","Slovenia":"si","Solomon Islands":"sb","Somalia":"so","South Africa":"za",
      "South Korea":"kr","South Sudan":"ss","Spain":"es","Sri Lanka":"lk","Sudan":"sd",
      "Suriname":"sr","Sweden":"se","Switzerland":"ch","Syria":"sy","Taiwan":"tw",
      "Tajikistan":"tj","Tanzania":"tz","Thailand":"th","Timor-Leste":"tl","Togo":"tg",
      "Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn","Turkey":"tr","Turkmenistan":"tm",
      "Uganda":"ug","Ukraine":"ua","United Arab Emirates":"ae","United Kingdom":"gb",
      "Great Britain":"gb","United States":"us","Uruguay":"uy","Uzbekistan":"uz","Vanuatu":"vu",
      "Vatican City":"va","Venezuela":"ve","Vietnam":"vn","Yemen":"ye","Zambia":"zm","Zimbabwe":"zw"
    };

    // Utility: build the pagination buttons (Option D)
    function buildPagination(container, info, table) {
      container.innerHTML = ""; // clear
      const pages = info.pages;
      const page = info.page; // zero-based
      const first = 0;
      const last = pages - 1;

      function makeBtn(label, disabled, classes) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = (classes || '') + ' px-2 py-1 rounded-md text-sm bg-transparent border border-transparent hover:bg-white/5';
        btn.innerHTML = label;
        if (disabled) btn.disabled = true;
        return btn;
      }

      // Previous
      const prev = makeBtn('Previous', page === first, 'prev-btn');
      prev.onclick = () => { if (page > first) table.page(page - 1).draw('page'); };
      container.appendChild(prev);

      // If small number of pages, show all
      if (pages <= 7) {
        for (let i = 0; i < pages; i++) {
          const pbtn = makeBtn((i+1).toString(), false, i === page ? 'bg-white/10 font-semibold' : '');
          pbtn.onclick = () => { table.page(i).draw('page'); };
          container.appendChild(pbtn);
        }
      } else {
        // Always show 1
        const firstBtn = makeBtn('1', false, page === 0 ? 'bg-white/10 font-semibold' : '');
        firstBtn.onclick = () => { table.page(0).draw('page'); };
        container.appendChild(firstBtn);

        // Left ellipsis if needed
        if (page > 2) {
          const leftEll = document.createElement('span'); leftEll.textContent = '…'; leftEll.className='px-2';
          container.appendChild(leftEll);
        }

        // Pages around current: show current-1, current, current+1 as available
        const start = Math.max(1, page - 1);
        const end = Math.min(last - 1, page + 1);
        for (let i = start; i <= end; i++) {
          const pbtn = makeBtn((i+1).toString(), false, i === page ? 'bg-white/10 font-semibold' : '');
          pbtn.onclick = () => { table.page(i).draw('page'); };
          container.appendChild(pbtn);
        }

        // Right ellipsis if needed
        if (page < last - 2) {
          const rightEll = document.createElement('span'); rightEll.textContent = '…'; rightEll.className='px-2';
          container.appendChild(rightEll);
        }

        // Always show last
        const lastBtn = makeBtn((last+1).toString(), false, page === last ? 'bg-white/10 font-semibold' : '');
        lastBtn.onclick = () => { table.page(last).draw('page'); };
        container.appendChild(lastBtn);
      }

      // Next
      const next = makeBtn('Next', page === last, 'next-btn');
      next.onclick = () => { if (page < last) table.page(page + 1).draw('page'); };
      container.appendChild(next);
    }

    // Update info text center
    function updateInfo(container, info) {
      // info.start, info.end, info.recordsDisplay, info.recordsTotal
      container.textContent = `Showing ${info.start + 1} to ${info.end} of ${info.recordsDisplay} entries`;
    }

    // Hook DataTables lifecycle: init with dom:'t' only, then build custom controls
    (function init() {
      fetch(CSV_URL)
        .then(r => r.text())
        .then(text => {
          if (text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

          const parsed = Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            delimiter: ";",
            trimHeaders: true,
            transformHeader: h => h.trim(),
            transform: v => v ? v.trim() : ""
          });

          const columnsToShow = [
            "Date","Country","Rider","Team","Competition","Class",
            "Rank","Result Type","UCI Points","Level","Season Result Rank"
          ];

          const tableData = parsed.data
            .filter(r => r.Date && r.Rider)
            .map(row => {
              const country = row["Country"] || "";
              const code = countryFlags[country] || "";
              const flagHtml = code
                ? `<div class="flag-container"><img src="https://flagcdn.com/${code}.svg" class="flag-img" alt="${country}" loading="lazy"><div class="tooltip">${country}</div></div>`
                : country;

              return columnsToShow.map(col => (col === "Country" ? flagHtml : (row[col] ?? "")));
            });

          // init DataTable with only the table (no built-in controls)
          const table = $('#resultsTable').DataTable({
            data: tableData,
            columns: [
              { title: "Date" },
              { title: "Nation" },
              { title: "Rider" },
              { title: "Team" },
              { title: "Race" },
              { title: "Class" },
              { title: "Rank" },
              { title: "Type" },
              { title: "UCI Pts" },
              { title: "Level" },
              { title: '<span title="Rider&#39;s Season Result Rank">RSRR</span>' }
            ],

            // disable default UI elements (we will create our own)
            dom: 't',

            // scrolling configuration: table body fills wrapper
            scrollY: '100%',
            scrollX: true,
            scrollCollapse: true,

            pageLength: 100,
            lengthMenu: [50, 100, 250, 500],
            order: [[0, 'desc']],
            autoWidth: false,

            columnDefs: [
              { width: "88px", targets: 0 },
              { width: "40px", targets: 1 },
              { width: "265px", targets: 2 },
              { width: "245px", targets: 3 },
              { width: "260px", targets: 4 },
              { width: "48px", targets: 5 },
              { width: "44px", targets: 6 },
              { width: "78px", targets: 7 },
              { width: "62px", targets: 8 },
              { width: "52px", targets: 9 },
              { width: "54px", targets: 10 },

              // True date sorting (DD/MM/YYYY -> YYYY-MM-DD)
              {
                targets: 0,
                type: 'date',
                render: function(data, type) {
                  if ((type === 'sort' || type === 'type') && typeof data === 'string' && data.includes('/')) {
                    const [d, m, y] = data.split('/');
                    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                  }
                  return data;
                }
              }
            ]
          });

          // containers
          const pagContainer = document.getElementById('pagContainer');
          const infoContainer = document.getElementById('infoContainer');
          const searchInput = document.getElementById('footerSearch');

          // wire search input to DataTables
          searchInput.addEventListener('input', function () {
            const v = this.value;
            table.search(v).draw();
          });

          // redraw footer controls each time table draws (page/search/ordering)
          table.on('draw', function () {
            const info = table.page.info();
            buildPagination(pagContainer, info, table); // builds buttons and attaches handlers
            updateInfo(infoContainer, info);
          });

          // initial populate
          table.draw(false);

          // keyboard: pressing Enter inside search moves focus to table
          searchInput.addEventListener('keydown', function (ev) {
            if (ev.key === 'Enter') {
              ev.preventDefault();
              // keep focus but trigger search (already done on input)
              // optionally, jump to first page of filtered results:
              table.page(0).draw('page');
            }
          });

          // help sizing: trigger columns adjust after initial draw
          setTimeout(() => {
            table.columns.adjust();
          }, 120);

        }).catch(err => {
          console.error("Failed to load CSV:", err);
        });
    })();
  </script>
</body>
</html>
