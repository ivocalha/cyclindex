<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">
  <title>Results Log – Cyclindex</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.2/css/buttons.tailwindcss.css">
  <style>
    @font-face { font-family: 'Suissnord'; src: url('Suissnord.otf') format('opentype'); font-display: swap; }
    body { background:#0f172a; color:white; margin:0; padding:0; }

    /* NAVIGATION */
    .nav-bar { background: rgba(15,23,42,0.9); backdrop-filter: blur(12px); padding: 1rem 2rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .nav-links { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
    .nav-links a { color: white; font-family: 'Suissnord', sans-serif; font-size: 1.1rem; text-decoration: none; padding: 0.5rem 1rem; border-radius: 0.8rem; transition: all 0.3s; }
    .nav-links a:hover { background: rgba(59,130,246,0.4); transform: translateY(-2px); }
    .nav-links a.active { background: rgba(59,130,246,0.6); }

    /* CONTAINER */
    .container { padding: 1rem 2vw 12rem; max-width: 100%; margin: 0 auto; }
    .table-wrapper { position: relative; max-height: 80vh; overflow: auto; }
    #resultsTable { background:rgba(255,255,255,0.08); backdrop-filter:blur(24px); border-radius:2rem; overflow:hidden; box-shadow:0 40px 120px rgba(0,0,0,0.95); font-size:0.89rem; }

    /* HEADER – SAME AS team-score.html (NO Suissnord) */
    #resultsTable thead th {
      background:#1e40af !important;
      font-family: inherit !important;
      font-size: 1rem !important;
      padding: 1rem 0.5rem !important;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 0 !important;
    }
    #resultsTable tbody td { padding:0.7rem 0.4rem !important; text-align:center; vertical-align:middle; line-height:1.2; }
    #resultsTable tbody tr:hover { background:rgba(59,130,246,0.28) !important; }

    .flag-img { width:23px; height:17px; border-radius:2px; box-shadow:0 1px 3px rgba(0,0,0,0.6); transition:transform .2s; }
    .flag-img:hover { transform:scale(2.2); }
    .tooltip { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.94); color:white; padding:6px 10px; border-radius:6px; font-size:0.84rem; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; margin-bottom:6px; z-index:1000; }
    .flag-container:hover .tooltip { opacity:1; }
    .flag-container { position:relative; display:inline-block; cursor:help; }

    .header-tooltip { position:relative; display:inline-block; cursor:help; width:100%; }
    .th-tooltip { position:absolute; top:100%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.94); color:white; padding:8px 12px; border-radius:6px; font-size:0.88rem; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; margin-top:8px; z-index:1000; width:max-content; max-width:280px; }
    .header-tooltip:hover .th-tooltip { opacity:1; }
  </style>
</head>
<body>

  <!-- NAVIGATION – Results Log between Home and Rider Score -->
  <nav class="nav-bar">
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="results-log.html" class="active">Results Log</a>
      <a href="rider-score.html">Rider Score</a>
      <a href="team-score.html">Team Score</a>
      <a href="nation-score.html">Nation Score</a>
      <a href="how-it-works.html">How It Works</a>
    </div>
  </nav>

  <!-- TABLE – NO H1 -->
  <div class="container">
    <div class="table-wrapper">
      <table id="resultsTable" class="display nowrap" style="width:100%">
        <thead>
          <tr>
            <th>Date</th>
            <th class="header-tooltip">Nation<span class="th-tooltip">Country/Nation</span></th>
            <th>Rider</th>
            <th>Team</th>
            <th>Race</th>
            <th>Class</th>
            <th>Rank</th>
            <th class="header-tooltip">Type<span class="th-tooltip">Result Type</span></th>
            <th>UCI Pts</th>
            <th>Level</th>
            <th class="header-tooltip">RSRR<span class="th-tooltip">Rider's Season Result Rank</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/dataTables.buttons.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.colVis.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Papaparse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv";

    const countryFlags = { /* ← full map same as before */ };

    fetch(CSV_URL)
      .then(r => r.text())
      .then(text => {
        // REMOVED BOM check — we rely on trim() instead
        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: true,
          delimiter: ";",
          trimHeaders: true,
          transformHeader: h => h.trim(),  // ← THIS REMOVES BOM
          transform: v => v ? v.trim() : ""
        });

        const columnsToShow = ["Date","Country","Rider","Team","Competition","Class","Rank","Result Type","UCI Points","Level","Season Result Rank"];

        const tableData = parsed.data
          .filter(r => r.Date && r.Rider)
          .map(row => {
            const country = row["Country"] || "";
            const code = countryFlags[country] || "";
            const flagHtml = code
              ? `<div class="flag-container"><img src="https://flagcdn.com/48x36/${code}.png" class="flag-img" alt="${country}" loading="lazy"><div class="tooltip">${country}</div></div>`
              : country;

            return columnsToShow.map(col => col === "Country" ? flagHtml : (row[col] ?? ""));
          })
          .sort((a, b) => {
            const [d1,m1,y1] = a[0].split('/').map(Number);
            const [d2,m2,y2] = b[0].split('/').map(Number);
            return new Date(y2, m2-1, d2) - new Date(y1, m1-1, d1);
          });

        $('#resultsTable').DataTable({
          data: tableData,
          columns: [
            { title: "Date" },
            { title: "Nation" },
            { title: "Rider" },
            { title: "Team" },
            { title: "Race" },
            { title: "Class" },
            { title: "Rank" },
            { title: "Type" },
            { title: "UCI Pts" },
            { title: "Level" },
            { title: "RSRR" }
          ],
          pageLength: 100,
          lengthMenu: [50, 100, 250, 500],
          order: [[0, 'desc']],
          scrollX: true,
          scrollY: '60vh',
          scrollCollapse: true,
          colReorder: true,
          dom: 'Bfrtip',
          buttons: ['colvis'],
          language: { search: "Filter:", lengthMenu: "Show _MENU_ rows" },
          autoWidth: false,
          columnDefs: [
            { width: "88px",  targets: 0 },
            { width: "40px",  targets: 1 },
            { width: "265px", targets: 2 },
            { width: "245px", targets: 3 },
            { width: "260px", targets: 4 },
            { width: "48px",  targets: 5 },
            { width: "44px",  targets: 6 },
            { width: "78px",  targets: 7 },
            { width: "62px",  targets: 8 },
            { width: "52px",  targets: 9 },
            { width: "54px",  targets: 10 }
          ],
          columnDefs: [
            {
              targets: 0,
              type: 'date',
              render: function(data, type) {
                if (type === 'sort' || type === 'type') {
                  if (!data) return '';
                  const [d, m, y] = data.split('/');
                  return `${y.padStart(4,'0')}${m.padStart(2,'0')}${d.padStart(2,'0')}`;
                }
                return data;
              }
            }
          ]
        });
      })
      .catch(err => {
        console.error("Load failed:", err);
        document.querySelector('#resultsTable tbody').innerHTML = 
          `<tr><td colspan="11" style="text-align:center; color:#f87171; padding:2rem;">
            Failed to load data. Check console.
           </td></tr>`;
      });
  </script>
</body>
</html>
