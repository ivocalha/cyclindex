<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Results Log – Cyclindex</title>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/4.0.1/css/fixedHeader.dataTables.min.css">

  <style>
    @font-face {font-family:'Suissnord';src:url('Suissnord.otf') format('opentype');font-display:swap;}
    :root{
      --nav-height:71px;--footer-height:64px;--pill-radius:0.7rem;--pill-bg:rgba(59,130,246,0.35);
      --neon-blue:#3b82f6;--header-blue:#1a2f55;--header-radius:14px;
    }
    html,body{height:100%;margin:0;background:#0f172a;color:white;overflow:hidden;}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}

    /* NAV */
    .nav-bar{position:fixed;top:0;left:0;right:0;height:var(--nav-height);background:rgba(15,23,42,0.9);
      backdrop-filter:blur(12px);display:flex;align-items:center;padding:1rem 2rem;z-index:3000;
      box-shadow:0 4px 20px rgba(0,0,0,0.5);}
    .nav-links{display:flex;gap:2rem;width:100%;justify-content:center;}
    .nav-links a{font-family:'Suissnord',sans-serif;text-decoration:none;font-size:1.05rem;color:white;
      padding:0.45rem 0.9rem;border-radius:var(--pill-radius);transition:all .18s;}
    .nav-links a.active,.nav-links a:hover{background:var(--pill-bg);transform:translateY(-2px);}

    /* SCROLL AREA */
    .table-wrapper{
      position:fixed;top:var (--nav-height);left:0;right:0;bottom:var(--footer-height);
      padding:10px 18px;overflow:auto;-webkit-overflow-scrolling:touch;
    }

    /* TABLE */
    table.dataTable{
      width:100% !important;border-collapse:separate;border-spacing:0;
      background:rgba(255,255,255,0.06);border-radius:var(--header-radius);
      box-shadow:0 30px 90px rgba(0,0,0,0.85);backdrop-filter:blur(18px);
    }
    table.dataTable thead th{
      background:var(--header-blue) !important;color:white !important;
      font-size:1.02rem !important;font-weight:600 !important;text-align:center;white-space:nowrap;
      padding:0.85rem 0.5rem !important;
    }
    table.dataTable thead th:first-child{border-top-left-radius:var(--header-radius);}
    table.dataTable thead th:last-child{border-top-right-radius:var(--header-radius);}

    #resultsTable tbody td{
      font-size:.89rem;white-space:nowrap;text-align:center;
      padding:.55rem 0.5rem !important;
    }
    #resultsTable tbody tr:hover{background:rgba(59,130,246,0.12) !important;}

    /* BOTTOM BAR */
    .fixed-bottom-bar{
      position:fixed;bottom:0;left:0;right:0;height:var(--footer-height);
      background:rgba(15,23,42,0.95);backdrop-filter:blur(12px);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 1.25rem;box-shadow:0 -6px 20px rgba(0,0,0,0.45);z-index:2900;
    }
    .entries-pill{background:var(--pill-bg);padding:6px 14px;border-radius:var(--pill-radius);font-size:0.95rem;}

    /* SEARCH – perfectly aligned */
    .search-wrap{display:flex;align-items:center;gap:10px;}
    .search-wrap svg{width:20px;height:20px;flex-shrink:0;stroke:var(--neon-blue);stroke-width:2;fill:none;}
    .search-wrap input{
      width:220px;padding:8px 12px;border-radius:var(--pill-radius);
      background:rgba(255,255,255,0.08);border:none;outline:none;color:white;font-size:0.95rem;
    }
    @media(max-width:720px){.search-wrap input{width:140px;}}

    /* FLAGS */
    .flag-img{width:22px;height:16px;border-radius:2px;box-shadow:0 1px 3px rgba(0,0,0,0.35);transition:transform .18s;}
    .flag-img:hover{transform:scale(2);}
    .flag-container{position:relative;display:inline-block;}
    .flag-container .tooltip{
      position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,0.9);color:white;padding:6px 10px;border-radius:6px;
      white-space:nowrap;opacity:0;transition:opacity .15s;pointer-events:none;margin-bottom:6px;z-index:3000;
    }
    .flag-container:hover .tooltip{opacity:1;}
  </style>
</head>
<body>

<nav class="nav-bar">
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="results-log.html" class="active">Results Log</a>
    <a href="rider-score.html">Rider Score</a>
    <a href="team-score.html">Team Score</a>
    <a href="nation-score.html">Nation Score</a>
    <a href="how-it-works.html">How It Works</a>
  </div>
</nav>

<div class="table-wrapper" id="tableWrapper">
  <table id="resultsTable" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>Date</th><th>Nation</th><th>Rider</th><th>Team</th><th>Race</th>
        <th>Class</th><th>Rank</th><th>Type</th><th>UCI Pts</th><th>Level</th>
        <th title="Rider's Season Result Rank">RSRR</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="fixed-bottom-bar">
  <div class="footer-left" id="pagContainer"></div>
  <div class="footer-center"><span id="infoContainer" class="entries-pill"></span></div>
  <div class="footer-right">
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7"/><line x1="16.65" y1="16.65" x2="21" y2="21" stroke-linecap="round"/></svg>
      <input id="footerSearch" placeholder="Search…">
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/fixedheader/4.0.1/js/fixedHeader.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const countryFlags = { /* ← your full object unchanged → */
  "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao","Antigua and Barbuda":"ag",
  "Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at","Azerbaijan":"az","Bahamas":"bs",
  "Bahrain":"bh","Bangladesh":"bd","Barbados":"bb","Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj",
  /* ... all the rest exactly as before ... */
  "United Kingdom":"gb","Great Britain":"gb","United States":"us","Uruguay":"uy","Uzbekistan":"uz","Vanuatu":"vu",
  "Vatican City":"va","Venezuela":"ve","Vietnam":"vn","Yemen":"ye","Zambia":"zm","Zimbabwe":"zw","Hong Kong":"hk"
};

const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv";

function buildPagination(c,i,t){c.innerHTML="";const p=i.page,l=i.pages-1;
  const b=(txt,dis,page,act=false)=>{const el=document.createElement('button');el.textContent=txt;
    el.className='px-2 py-1 rounded text-sm hover:bg-white/5';if(act)el.classList.add('pagination-pill');
    if(!dis)el.onclick=()=>t.page(page).draw('page');else el.disabled=true;return el;};
  c.appendChild(b('Previous',p===0,p-1));
  c.appendChild(b('1',false,0,p===0)); if(p>2)c.appendChild(document.createTextNode(' … '));
  for(let x=Math.max(1,p-1);x<=Math.min(l-1,p+1);x++)c.appendChild(b(String(x+1),false,x,x===p));
  if(p<l-2)c.appendChild(document.createTextNode(' … '));
  if(i.pages>1)c.appendChild(b(String(l+1),false,l,p===l));
  c.appendChild(b('Next',p===l,p+1));
}
function updateInfo(c,i){c.textContent=`Showing ${i.start+1} to ${i.end} of ${i.recordsDisplay} entries`;}

fetch(CSV_URL).then(r=>r.text()).then(text=>{
  if(text.charCodeAt(0)===0xFEFF)text=text.slice(1);
  const parsed=Papa.parse(text,{header:true,skipEmptyLines:true,dynamicTyping:true,delimiter:";",transformHeader:h=>h.trim(),transform:v=>v?v.trim():""});
  const cols=["Date","Country","Rider","Team","Competition","Class","Rank","Result Type","UCI Points","Level","Season Result Rank"];
  const data=parsed.data.filter(r=>r.Date&&r.Rider).map(r=>{
    const code=countryFlags[r.Country]||"";
    const flag=code?`<div class="flag-container"><img class="flag-img" src="https://flagcdn.com/${code}.svg"><div class="tooltip">${r.Country}</div></div>`:r.Country;
    return cols.map(f=>f==="Country"?flag:(r[f]||""));
  });

  const table = $('#resultsTable').DataTable({
    data: data,
    dom: 't',
    pageLength: 100,
    autoWidth: false,
    order: [[0,'desc']],
    fixedHeader: {
      header: true,
      headerOffset: 71                     // height of your fixed nav
    },
    // THIS IS THE FINAL FIX:
    initComplete: function () {
      this.api().fixedHeader.enable();   // force FixedHeader to attach to body, not the scrolling div
    }
  });

  const pag = document.getElementById('pagContainer');
  const info = document.getElementById('infoContainer');
  const search = document.getElementById('footerSearch');

  search.addEventListener('input',()=>table.search(search.value).draw());
  table.on('draw',()=>{const i=table.page.info();buildPagination(pag,i,table);updateInfo(info,i);});

  setTimeout(()=>table.columns.adjust(), 150);
  window.addEventListener('resize',()=>setTimeout(()=>table.columns.adjust(), 160));
  table.draw(false);
});
</script>
</body>
</html>
