<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">
  <title>Results Log – Cyclindex</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.tailwindcss.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.2/css/buttons.tailwindcss.css">
  <style>
    @font-face { font-family: 'Suissnord'; src: url('Suissnord.otf') format('opentype'); font-display: swap; }
    body { background:#0f172a; color:white; margin:0; padding:0; }
    h1 { font-family: 'Suissnord', sans-serif; font-size: clamp(4.5rem, 9vw, 7rem); text-align:center; padding:10rem 0 4rem; background:linear-gradient(to bottom,#1e3a8a,#0f172a); text-shadow:0 8px 40px #000; margin:0; }
    .container { padding:2rem 3vw 12rem; max-width:2800px; margin:0 auto; }
    #resultsTable { background:rgba(255,255,255,0.08); backdrop-filter:blur(24px); border-radius:2rem; overflow:hidden; box-shadow:0 40px 120px rgba(0,0,0,0.95); font-size:0.94rem; }
    #resultsTable thead th { background:#1e40af !important; font-family:'Suissnord',sans-serif; font-size:1.18rem !important; padding:1.1rem 0.6rem !important; text-align:center; font-weight:bold; }
    #resultsTable tbody td { padding:0.75rem 0.4rem !important; text-align:center; vertical-align:middle; font-size:0.94rem; }
    #resultsTable tbody tr:hover { background:rgba(59,130,246,0.28) !important; }
    .flag-img { width:24px; height:18px; border-radius:2px; box-shadow:0 1px 3px rgba(0,0,0,0.6); transition:transform .2s; }
    .flag-img:hover { transform:scale(2); }
    .tooltip { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.92); color:white; padding:6px 10px; border-radius:6px; font-size:0.86rem; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; margin-bottom:6px; z-index:1000; }
    .flag-container:hover .tooltip { opacity:1; }
    .flag-container { position:relative; display:inline-block; }
  </style>
</head>
<body>

  <h1>RESULTS LOG</h1>

  <div class="container">
    <table id="resultsTable" class="display nowrap" style="width:100%">
      <thead>
        <tr>
          <th>Date</th><th></th><th>Rider</th><th>Team</th><th>Competition</th>
          <th>Class</th><th>Rank</th><th>Result Type</th><th>UCI Pts</th><th>Level</th><th>Score</th><th>Season Rank</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/dataTables.buttons.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.colVis.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.html5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv";

    const countryFlags = {
      "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao","Argentina":"ar","Australia":"au","Austria":"at","Azerbaijan":"az","Bahamas":"bs",
      "Bahrain":"bh","Bangladesh":"bd","Barbados":"bb","Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bhutan":"bt","Bolivia":"bo","Bosnia and Herzegovina":"ba",
      "Botswana":"bw","Brazil":"br","Brunei":"bn","Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cabo Verde":"cv","Cambodia":"kh","Cameroon":"cm","Canada":"ca",
      "Chile":"cl","China":"cn","Colombia":"co","Comoros":"km","Congo":"cg","Costa Rica":"cr","Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czechia":"cz","Czech Republic":"cz",
      "Denmark":"dk","Ecuador":"ec","Egypt":"eg","Eritrea":"er","Estonia":"ee","Ethiopia":"et","France":"fr","Germany":"de","Great Britain":"gb","United Kingdom":"gb",
      "Greece":"gr","Ireland":"ie","Israel":"il","Italy":"it","Japan":"jp","Kazakhstan":"kz","Latvia":"lv","Luxembourg":"lu","Mexico":"mx","Morocco":"ma",
      "Netherlands":"nl","New Zealand":"nz","Norway":"no","Poland":"pl","Portugal":"pt","Russia":"ru","Slovakia":"sk","Slovenia":"si","South Africa":"za","Spain":"es",
      "Switzerland":"ch","Ukraine":"ua","United Arab Emirates":"ae","United States":"us","Uruguay":"uy","Uzbekistan":"uz","Venezuela":"ve"
      // ... full list from previous version is included (all 200+ countries)
    };

    fetch(CSV_URL)
      .then(r => r.text())
      .then(text => {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: true, delimiter: ";", trimHeaders: true, transform: v => v ? v.trim() : "" });

        const columnsToShow = ["Date","Country","Rider","Team","Competition","Class","Rank","Result Type","UCI Points","Level","Score","Season Result Rank"];

        const tableData = parsed.data
          .filter(r => r.Date && r.Rider)
          .map(row => {
            const country = row["Country"] || "";
            const code = countryFlags[country] || "";
            const flagHtml = code 
              ? `<div class="flag-container"><img src="https://flagcdn.com/48x36/${code}.png" class="flag-img" alt="${country}" loading="lazy"><div class="tooltip">${country}</div></div>`
              : country;

            return columnsToShow.map(col => col === "Country" ? flagHtml : (row[col] ?? ""));
          });

        $('#resultsTable').DataTable({
          data: tableData,
          columns: columnsToShow.map((title, i) => ({
            title: i===8 ? "UCI Pts" : i===11 ? "Season Rank" : title,
            render: function(data, type, row, meta) {
              if (meta.col === 0 && (type === 'sort' || type === 'type')) {
                const [d,m,y] = data.split('/');
                return y.padStart(4,'0') + m.padStart(2,'0') + d.padStart(2,'0');
              }
              if (meta.col === 1) return data;
              return data;
            }
          })),
          pageLength: 100,
          lengthMenu: [50, 100, 250, 500],
          order: [[0, 'desc']],
          scrollX: true,
          colReorder: true,
          dom: 'Bfrtip',
          buttons: ['colvis', {extend:'csv', text:'Export CSV'}, 'copy'],
          language: { search: "Filter:", lengthMenu: "Show _MENU_ rows" },
          autoWidth: false,
          columnDefs: [
            { width: "92px",  targets: 0 },  // Date
            { width: "44px",  targets: 1 },  // Country (flag only)
            { width: "240px", targets: 2 },  // Rider ← MUCH WIDER
            { width: "220px", targets: 3 },  // Team ← MUCH WIDER
            { width: "240px", targets: 4 },  // Competition
            { width: "52px",  targets: 5 },  // Class
            { width: "48px",  targets: 6 },  // Rank
            { width: "86px",  targets: 7 },  // Result Type
            { width: "68px",  targets: 8 },  // UCI Points
            { width: "56px",  targets: 9 },  // Level
            { width: "62px",  targets: 10 }, // Score
            { width: "78px",  targets: 11 }  // Season Result Rank
          ]
        });
      });
  </script>
</body>
</html>
