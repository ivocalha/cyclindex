<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="cyclindex_logo.png">
  <title>Cyclindex – Professional Cycling Index</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face{font-family:'Suissnord';src:url('Suissnord.otf') format('opentype');font-weight:normal;font-style:normal;font-display:swap;}
    body,html{height:100%;margin:0;background:linear-gradient(135deg,#0f172a 0%,#1e40af 100%);color:white;}
    .grid-container{display:grid;grid-template-columns:300px 1fr 300px;height:100vh;gap:0.75rem;padding:0.75rem;box-sizing:border-box;}
    .hero-zone{grid-column:1/4;text-align:center;padding:0.4rem 0;}
    .logo-title{display:flex;align-items:center;justify-content:center;gap:0.8rem;}
    .logo-img{height:48px;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.6));}
    .title{font-family:'Suissnord',sans-serif;font-size:2.6rem;margin:0;color:white;text-shadow:0 2px 8px rgba(0,0,0,0.7);}
    .nav-buttons{display:flex;justify-content:center;gap:0.6rem;margin-top:0.4rem;flex-wrap:wrap;}
    .nav-btn{background:rgba(255,255,255,0.22);backdrop-filter:blur(8px);border-radius:0.75rem;padding:0.45rem 0.75rem;font-size:0.82rem;font-weight:600;transition:all .3s;box-shadow:0 3px 10px rgba(0,0,0,0.2);}
    .nav-btn:hover{background:rgba(255,255,255,0.35);transform:translateY(-4px);}
    .left-col,.center-col,.right-col{display:grid;gap:0.75rem;}
    .right-col{grid-template-rows:1fr 1fr;}
    .block{background:rgba(15,23,42,0.45);backdrop-filter:blur(12px);border-radius:0.9rem;padding:0.75rem;box-shadow:0 5px 18px rgba(0,0,0,0.3);transition:all .4s ease;}
    .block:hover{background:rgba(15,23,42,0.65);transform:translateY(-6px);box-shadow:0 15px 35px rgba(0,0,0,0.45);}
    .block h3{font-family:'Suissnord',sans-serif;font-size:1.15rem;margin:0 0 0.4rem;display:flex;align-items:center;gap:0.6rem;}
    .icon-header{width:28px;height:28px;}
    table{width:100%;border-collapse:collapse;font-size:0.84rem;}
    th{text-align:left;font-weight:600;font-size:0.76rem;opacity:0.9;padding-bottom:0.3rem;border-bottom:1px solid rgba(255,255,255,0.2);}
    td{padding:0.28rem 0;border-bottom:1px solid rgba(255,255,255,0.08);}
    tr:last-child td{border:none;}
    /* Top 10 Riders column layout */
    #top-riders-table th:nth-child(1), #top-riders-table td:nth-child(1) {width:5%; text-align:center;}
    #top-riders-table th:nth-child(2), #top-riders-table td:nth-child(2) {width:8%; text-align:center;} /* Flag */
    #top-riders-table th:nth-child(3), #top-riders-table td:nth-child(3) {width:30%; font-weight:600;} /* Rider */
    #top-riders-table th:nth-child(4), #top-riders-table td:nth-child(4) {width:28%;} /* Team */
    #top-riders-table th:nth-child(5), #top-riders-table td:nth-child(5),
    #top-riders-table th:nth-child(6), #top-riders-table td:nth-child(6),
    #top-riders-table th:nth-child(7), #top-riders-table td:nth-child(7),
    #top-riders-table th:nth-child(8), #top-riders-table td:nth-child(8) {text-align:right; width:7.25%;}
    .flag{width:26px;height:18px;border-radius:3px;box-shadow:0 1px 3px rgba(0,0,0,0.4);transition:transform .2s;}
    .flag:hover{transform:scale(1.4);z-index:10;}
    .flag-name{position:absolute;background:rgba(0,0,0,0.85);color:white;font-size:11px;padding:3px 6px;border-radius:3px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:4px;}
    .flag-container{position:relative;display:inline-block;}
    .flag-container:hover .flag-name{opacity:1;}
    @media (max-width:1366px){
      .grid-container{grid-template-columns:280px 1fr 280px;padding:0.6rem;gap:0.6rem;}
      .title{font-size:2.4rem;}.logo-img{height:44px;}
      table{font-size:0.82rem;} th{font-size:0.74rem;}
      .flag{width:24px;height:16px;}
    }
  </style>
</head>
<body>
  <div class="grid-container">
    <div class="hero-zone">
      <div class="logo-title">
        <img src="cyclindex_logo.png" alt="Cyclindex" class="logo-img">
        <h1 class="title">Cyclindex</h1>
      </div>
      <div class="nav-buttons">
        <a href="results-log.html" class="nav-btn">Results Log</a>
        <a href="rider-score.html" class="nav-btn">Rider Score</a>
        <a href="team-score.html" class="nav-btn">Team Score</a>
        <a href="nation-score.html" class="nav-btn">Nation Score</a>
        <a href="how-it-works.html" class="nav-btn">How It Works</a>
      </div>
    </div>

    <div class="left-col">
      <div class="block">
        <h3><svg class="icon-header" viewBox="0 0 24 24"><path fill="white" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2Z"/></svg> Latest Results</h3>
        <table id="latest-results-table"><tbody><tr><td colspan="2">Loading...</td></tr></tbody></table>
      </div>
      <div class="block">
        <h3><svg class="icon-header" viewBox="0 0 24 24"><path fill="white" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14z"/></svg> Next 5 Races</h3>
        <table id="upcoming-table"><tbody><tr><td colspan="2">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <div class="center-col">
      <div class="block" style="display:flex;flex-direction:column;height:100%;">
        <h3><img src="rider_icon.png" class="icon-header"> Top 10 Riders</h3>
        <table id="top-riders-table" style="flex:1;">
          <thead>
            <tr>
              <th>#</th>
              <th></th> <!-- Flag column -->
              <th>Rider</th>
              <th>Team</th>
              <th>Best Result</th>
              <th>2nd Best</th>
              <th>3rd Best</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="8">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="right-col">
      <div class="block">
        <h3><img src="team_icon.png" class="icon-header"> Top 5 Teams</h3>
        <table id="top-teams-table"><thead><tr><th>#</th><th>Team</th><th>Score</th></tr></thead><tbody><tr><td colspan="3">Loading...</td></tr></tbody></table>
      </div>
      <div class="block">
        <h3><img src="nation_icon.png" class="icon-header"> Top 5 Nations</h3>
        <table id="top-nations-table"><thead><tr><th>#</th><th>Nation</th><th>Score</th></tr></thead><tbody><tr><td colspan="3">Loading...</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <script>
    // Full flag list (same as rider-score.html)
    const flags = {
      "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao","Antigua and Barbuda":"ag","Argentina":"ar","Armenia":"am","Australia":"au",
      "Austria":"at","Azerbaijan":"az","Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb","Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj",
      "Bermuda":"bm","Bhutan":"bt","Bolivia":"bo","Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn","Bulgaria":"bg","Burkina Faso":"bf",
      "Burundi":"bi","Cambodia":"kh","Cameroon":"cm","Canada":"ca","Cape Verde":"cv","Cayman Islands":"ky","Central African Republic":"cf","Chad":"td","Chile":"cl",
      "China":"cn","Colombia":"co","Comoros":"km","Congo":"cg","Costa Rica":"cr","Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czech Republic":"cz","Denmark":"dk",
      "Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Ecuador":"ec","Egypt":"eg","El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er","Estonia":"ee",
      "Eswatini":"sz","Ethiopia":"et","Fiji":"fj","Finland":"fi","France":"fr","Gabon":"ga","Gambia":"gm","Georgia":"ge","Germany":"de","Ghana":"gh","Greece":"gr",
      "Grenada":"gd","Guatemala":"gt","Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy","Haiti":"ht","Honduras":"hn","Hong Kong":"hk","Hungary":"hu","Iceland":"is",
      "India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq","Ireland":"ie","Israel":"il","Italy":"it","Ivory Coast":"ci","Jamaica":"jm","Japan":"jp","Jordan":"jo",
      "Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki","Kosovo":"xk","Kuwait":"kw","Kyrgyzstan":"kg","Laos":"la","Latvia":"lv","Lebanon":"lb","Lesotho":"ls",
      "Liberia":"lr","Libya":"ly","Liechtenstein":"li","Lithuania":"lt","Luxembourg":"lu","Madagascar":"mg","Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml",
      "Malta":"mt","Marshall Islands":"mh","Mauritania":"mr","Mauritius":"mu","Mexico":"mx","Moldova":"md","Monaco":"mc","Mongolia":"mn","Montenegro":"me",
      "Morocco":"ma","Mozambique":"mz","Myanmar":"mm","Namibia":"na","Nauru":"nr","Nepal":"np","Netherlands":"nl","New Zealand":"nz","Nicaragua":"ni","Niger":"ne",
      "Nigeria":"ng","North Macedonia":"mk","Norway":"no","Oman":"om","Pakistan":"pk","Palau":"pw","Palestine":"ps","Panama":"pa","Papua New Guinea":"pg",
      "Paraguay":"py","Peru":"pe","Philippines":"ph","Poland":"pl","Portugal":"pt","Qatar":"qa","Romania":"ro","Russia":"ru","Rwanda":"rw","Saint Kitts and Nevis":"kn",
      "Saint Lucia":"lc","Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm","Sao Tome and Principe":"st","Saudi Arabia":"sa","Senegal":"sn",
      "Serbia":"rs","Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg","Slovakia":"sk","Slovenia":"si","Solomon Islands":"sb","Somalia":"so","South Africa":"za",
      "South Korea":"kr","South Sudan":"ss","Spain":"es","Sri Lanka":"lk","Sudan":"sd","Suriname":"sr","Sweden":"se","Switzerland":"ch","Syria":"sy","Taiwan":"tw",
      "Tajikistan":"tj","Tanzania":"tz","Thailand":"th","Timor-Leste":"tl","Togo":"tg","Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn","Turkey":"tr",
      "Turkmenistan":"tm","Tuvalu":"tv","Uganda":"ug","Ukraine":"ua","United Arab Emirates":"ae","United Kingdom":"gb","Great Britain":"gb","England":"gb-eng",
      "Scotland":"gb-sct","Wales":"gb-wls","United States":"us","Uruguay":"uy","Uzbekistan":"uz","Vanuatu":"vu","Vatican City":"va","Venezuela":"ve","Vietnam":"vn",
      "Yemen":"ye","Zambia":"zm","Zimbabwe":"zw"
    };

    const flagImg = country => {
      const code = flags[country] || 'xx';
      return `<div class="flag-container">
                <img src="https://flagcdn.com/48x36/${code}.png" srcset="https://flagcdn.com/96x72/${code}.png 2x" width="26" height="18" alt="${country}" class="flag">
                <div class="flag-name">${country}</div>
              </div>`;
    };

    const fmt = v => v?.trim() ? parseFloat(v.replace(',', '.'))?.toFixed(2) || v.trim() : '–';

    // Next 5 Races
    fetch('https://raw.githubusercontent.com/ivocalha/cyclindex/main/calendar.csv')
      .then(r => r.text())
      .then(csv => {
        const lines = csv.trim().split('\n').slice(1);
        const today = new Date(); today.setHours(0,0,0,0);
        const upcoming = [];
        for (const line of lines) {
          const p = line.split(';');
          if (p.length < 5) continue;
          const [d,m,y] = p[0].trim().split('/');
          const raceDate = new Date(`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`);
          if (raceDate >= today) {
            upcoming.push(p);
            if (upcoming.length === 5) break;
          }
        }
        document.querySelector('#upcoming-table tbody').innerHTML = upcoming.length
          ? upcoming.map(p => `<tr><td>${p[0].trim()}</td><td>${p[2].trim()}</td></tr>`).join('')
          : '<tr><td colspan="2">No upcoming races</td></tr>';
      });

    // Latest Results
    fetch('https://raw.githubusercontent.com/ivocalha/cyclindex/main/results-log.csv')
      .then(r => r.text())
      .then(text => {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        const lines = text.split('\n');
        const headers = lines[0].split(';');
        const dateIdx = headers.indexOf('Date'), compIdx = headers.indexOf('Competition');
        let maxDate = null, races = new Set();
        for (let i = 1; i < lines.length; i++) {
          const p = lines[i].split(';');
          const date = p[dateIdx]?.trim();
          if (!date) continue;
          const [d,m,y] = date.split('/');
          const cur = new Date(`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`);
          if (!maxDate || cur > maxDate) { maxDate = cur; races = new Set([p[compIdx].trim()]); }
          else if (cur.getTime() === maxDate.getTime()) races.add(p[compIdx].trim());
        }
        document.querySelector('#latest-results-table tbody').innerHTML = maxDate
          ? Array.from(races).sort().map(r => `<tr><td>${maxDate.toLocaleDateString('en-GB')}</td><td>${r}</td></tr>`).join('')
          : '<tr><td colspan="2">No results</td></tr>';
      });

    // Top 10 Riders – Now with FLAGS + hover tooltip (exact same style as rider-score.html)
    fetch('https://raw.githubusercontent.com/ivocalha/cyclindex/main/rider-score.csv')
      .then(r => r.text())
      .then(text => {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        const lines = text.split('\n');
        const top = [];
        for (let i = 1; i < lines.length; i++) {
          const p = lines[i].split(';');
          if (p.length < 31) continue;
          const rank = parseInt(p[2], 10);
          if (isNaN(rank) || rank < 1 || rank > 10) continue;
          top.push({
            rank,
            nation: p[4].trim(),
            rider: p[3].trim(),
            team: p[8].trim(),
            best: fmt(p[15]),
            second: fmt(p[21]),
            third: fmt(p[27]),
            score: fmt(p[28])
          });
        }
        top.sort((a,b) => a.rank - b.rank);
        document.querySelector('#top-riders-table tbody').innerHTML = top.map(t => `
          <tr>
            <td>${t.rank}</td>
            <td>${flagImg(t.nation)}</td>
            <td>${t.rider}</td>
            <td>${t.team}</td>
            <td>${t.best}</td>
            <td>${t.second}</td>
            <td>${t.third}</td>
            <td>${t.score}</td>
          </tr>
        `).join('');
      });

    // Top 5 Teams & Nations (unchanged)
    fetch('https://raw.githubusercontent.com/ivocalha/cyclindex/main/team-score.csv').then(r=>r.text()).then(t=>{if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);const l=t.split('\n'),out=[];for(let i=1;i<l.length;i++){const p=l[i].split(';');if(p.length<17)continue;const r=parseInt(p[2]);if(r>0&&r<=5)out.push({rank:r,team:p[3].trim(),score:fmt(p[16])});}out.sort((a,b)=>a.rank-b.rank);document.querySelector('#top-teams-table tbody').innerHTML=out.map(x=>`<tr><td>${x.rank}</td><td>${x.team}</td><td>${x.score}</td></tr>`).join('');});
    fetch('https://raw.githubusercontent.com/ivocalha/cyclindex/main/nation-score.csv').then(r=>r.text()).then(t=>{if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);const l=t.split('\n'),out=[];for(let i=1;i<l.length;i++){const p=l[i].split(';');if(p.length<15)continue;const r=parseInt(p[2]);if(r>0&&r<=5)out.push({rank:r,nation:p[3].trim(),score:fmt(p[14])});}out.sort((a,b)=>a.rank-b.rank);document.querySelector('#top-nations-table tbody').innerHTML=out.map(x=>`<tr><td>${x.rank}</td><td>${x.nation}</td><td>${x.score}</td></tr>`).join('');});
  </script>
</body>
</html>
